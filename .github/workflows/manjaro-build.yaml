name: Build Manjaro Packages + AUR

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  OUTPUT_DIR: /tmp/output
  REPO_NAME: manjaro-awesome
  AUR_HELPER: yay
  AUR_PACKAGES: "raw-thumbnailer grayjay-bin gsconnect lain-git awesome-git awesome-freedesktop-git tilix-git ttf-font-awesome-5 tamzen-font i3lock-fancy-git betterlockscreen nordic-theme nordic-darker-theme nordic-darker-standard-buttons-theme nordic-polar-standard-buttons-theme nordic-standard-buttons-theme nordic-bluish-accent-theme nordic-bluish-accent-standard-buttons-theme geany-nord-theme nordzy-icon-theme oh-my-posh-bin fish-done find-the-command p7zip-gui"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get latest bootstrap date
        id: bootstrap
        run: |
          LATEST=$(curl -s https://archlinux.org/iso/latest/ | grep -oP 'archlinux-bootstrap-\K\d{4}\.\d{2}\.\d{2}' | head -1)
          echo "date=${LATEST}" >> $GITHUB_OUTPUT

      - name: Install host dependencies
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential fakeroot git wget tar zstd xz-utils pkg-config curl

      - name: Create output directory
        run: |
          sudo mkdir -p ${OUTPUT_DIR}
          sudo chmod 777 ${OUTPUT_DIR}

      - name: Download and extract Arch bootstrap
        run: |
          wget -q "https://mirror.rackspace.com/archlinux/iso/latest/archlinux-bootstrap-${{ steps.bootstrap.outputs.date }}-x86_64.tar.zst"
          mkdir -p arch-bootstrap
          sudo tar -I zstd -xf archlinux-bootstrap-${{ steps.bootstrap.outputs.date }}-x86_64.tar.zst -C arch-bootstrap --strip-components=1

      - name: Initialize Arch chroot environment
        run: |
          # Copy repository into chroot
          sudo cp -r . arch-bootstrap/root.x86_64/mnt/repo
          sudo cp -r ${OUTPUT_DIR} arch-bootstrap/root.x86_64/mnt/output

          # Setup basic system and builder user in chroot
          sudo arch-bootstrap/root.x86_64/bin/arch-chroot /bin/bash -c "
            # Configure pacman and install essential packages
            echo 'Server = https://mirrors.kernel.org/archlinux/\$repo/os/\$arch' > /etc/pacman.d/mirrorlist
            pacman-key --init
            pacman-key --populate archlinux
            pacman -Sy --noconfirm
            pacman -S --noconfirm base-devel git sudo awk sed grep

            # Create builder user
            useradd -m builder -s /bin/bash
            echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
            echo 'root ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

            # Setup build environment
            mkdir -p /mnt/output
            chown -R builder:builder /mnt/repo
            chown -R builder:builder /mnt/output
          "

      - name: Install AUR helper
        run: |
          sudo arch-bootstrap/root.x86_64/bin/arch-chroot /bin/bash -c "
            set -e
            cd /tmp
            sudo -u builder git clone https://aur.archlinux.org/${AUR_HELPER}.git
            cd ${AUR_HELPER}
            sudo -u builder makepkg -si --noconfirm --clean
            cd ..
            rm -rf ${AUR_HELPER}
          "

      - name: Build local PKGBUILD packages
        run: |
          sudo arch-bootstrap/root.x86_64/bin/arch-chroot /bin/bash -c "
            set -e
            export OUTPUT_DIR=/mnt/output
            cd /mnt/repo
            
            # Find and build all local PKGBUILDs
            find . -maxdepth 2 -name PKGBUILD -exec dirname {} \; | while read pkgdir; do
              echo \"=== BUILDING LOCAL: \$pkgdir ===\"
              cd \"\$pkgdir\"
              sudo -u builder makepkg -s --noconfirm --clean || { echo \"makepkg failed in \$pkgdir\"; cd -; continue; }
              # Copy built packages to output
              for p in *.pkg.tar.zst; do
                [ -f \"\$p\" ] && cp \"\$p\" \"\$OUTPUT_DIR/\"
              done
              cd - >/dev/null
            done
          "

      - name: Build AUR packages
        run: |
          sudo arch-bootstrap/root.x86_64/bin/arch-chroot /bin/bash -c "
            set -e
            export OUTPUT_DIR=/mnt/output
            export AUR_PACKAGES='${AUR_PACKAGES}'
            
            # Build AUR packages using yay
            for pkg in \$AUR_PACKAGES; do
              echo \"=== BUILDING AUR: \$pkg ===\"
              sudo -u builder ${AUR_HELPER} -S --noconfirm --builddir /tmp/aur-build --clean --removemake \$pkg || {
                echo \"Failed to build \$pkg\"
                continue
              }
              # Copy built packages from yay cache
              find /home/builder/.cache/${AUR_HELPER} -name \"*.pkg.tar.zst\" -newer /proc/self -exec cp {} \"\$OUTPUT_DIR/\" \; 2>/dev/null || true
            done
            
            # Clean up build directory
            rm -rf /tmp/aur-build
          "

      - name: Create repository database
        run: |
          sudo arch-bootstrap/root.x86_64/bin/arch-chroot /bin/bash -c "
            cd /mnt/output
            # Create repo database
            repo-add ${REPO_NAME}.db.tar.gz *.pkg.tar.zst 2>/dev/null || true
          "

          # Copy packages back to host
          sudo cp -r arch-bootstrap/root.x86_64/mnt/output/* ${OUTPUT_DIR}/

      - name: Verify built packages
        run: |
          if [ $(find ${OUTPUT_DIR} -name '*.pkg.tar.zst' 2>/dev/null | wc -l) -eq 0 ]; then
            echo "ERROR: No packages were built!"
            exit 1
          fi
          echo "Successfully built $(find ${OUTPUT_DIR} -name '*.pkg.tar.zst' | wc -l) packages"
          ls -la ${OUTPUT_DIR}/

      - name: Set up git identity
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"

      - name: Deploy to GitHub Pages
        run: |
          # Create or reset gh-pages branch
          git checkout --orphan gh-pages
          git reset --hard
          
          # Copy all built packages
          cp -r ${OUTPUT_DIR}/* . || true
          
          # Commit and push
          git add -A
          git commit -m "Update Manjaro repository - $(date)" || echo "No changes to commit"
          git push -f origin gh-pages

      - name: Upload packages as artifact
        uses: actions/upload-artifact@v4
        with:
          name: manjaro-packages
          path: ${{ env.OUTPUT_DIR }}/*.pkg.tar.zst
          retention-days: 30

      - name: Cleanup
        run: |
          sudo rm -rf arch-bootstrap
          sudo rm -rf ${OUTPUT_DIR}