name: Clean Upload Test

on:
  workflow_dispatch:
    inputs:
      test_file_size_mb:
        description: 'Test file size in MB'
        default: '10'
        type: string

jobs:
  clean-test:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        env:
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          echo "=== TESZT K√ñRNYEZET BE√ÅLL√çT√ÅSA ==="
          
          # Alap csomagok
          pacman -Syu --noconfirm --needed openssh rsync coreutils
          
          # SSH kulcs be√°ll√≠t√°sa
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # SSH config minimaliz√°lva
          echo "Host $VPS_HOST" > ~/.ssh/config
          echo "  HostName $VPS_HOST" >> ~/.ssh/config
          echo "  User $VPS_USER" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_ed25519" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  ConnectTimeout 45" >> ~/.ssh/config
          echo "  ServerAliveInterval 20" >> ~/.ssh/config
          echo "  LogLevel ERROR" >> ~/.ssh/config
          
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null
          
          echo "‚úÖ SSH be√°ll√≠tva"

      - name: Run Upload Test
        env:
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          TEST_FILE_SIZE_MB: ${{ github.event.inputs.test_file_size_mb }}
        run: |
          echo "üöÄ TESZT INDUL..."
          echo "======================"
          
          # Ellen≈ërizz√ºk a v√°ltoz√≥kat
          echo "VPS_HOST: $VPS_HOST"
          echo "VPS_USER: $VPS_USER"
          echo "REMOTE_DIR: $REMOTE_DIR"
          echo "TEST_FILE_SIZE_MB: $TEST_FILE_SIZE_MB"
          echo ""
          
          # === 1. SSH KAPCSOLAT TESZT ===
          echo "üì° 1. SSH kapcsolat teszt..."
          if timeout 10 ssh "$VPS_USER@$VPS_HOST" "echo '‚úì SSH kapcsolat OK' && hostname"; then
            echo "‚úÖ SSH kapcsolat SIKERES"
          else
            echo "‚ùå SSH kapcsolat SIKERTELEN"
            exit 1
          fi
          
          echo ""
          
          # === 2. K√ñNYVT√ÅR ELLEN≈êRZ√âS ===
          echo "üìÅ 2. T√°voli k√∂nyvt√°r ellen≈ërz√©s..."
          if ssh "$VPS_USER@$VPS_HOST" "[ -d '$REMOTE_DIR' ] && echo '‚úì K√∂nyvt√°r l√©tezik' || echo '‚ùå K√∂nyvt√°r nem l√©tezik'"; then
            echo "‚úÖ K√∂nyvt√°r el√©rhet≈ë"
          else
            echo "‚ö†Ô∏è  K√∂nyvt√°r ellen≈ërz√©s nem siker√ºlt"
          fi
          
          echo ""
          
          # === 3. F√ÅJL L√âTREHOZ√ÅS ===
          echo "üì¶ 3. Tesztf√°jl l√©trehoz√°sa (${TEST_FILE_SIZE_MB}MB)..."
          TEST_FILE="/tmp/upload_test_$(date +%s).bin"
          dd if=/dev/urandom of="$TEST_FILE" bs=1M count=$TEST_FILE_SIZE_MB status=none
          FILE_SIZE=$(ls -lh "$TEST_FILE" | awk '{print $5}')
          echo "‚úÖ F√°jl l√©trehozva: $FILE_SIZE"
          
          echo ""
          
          # === 4. SCP FELT√ñLT√âS ===
          echo "‚ö° 4. SCP felt√∂lt√©s teszt..."
          REMOTE_FILE_SCP="$REMOTE_DIR/scp_test_$(date +%s).bin"
          
          START_TIME=$(date +%s)
          if scp -q "$TEST_FILE" "$VPS_USER@$VPS_HOST:$REMOTE_FILE_SCP"; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            if [ $DURATION -eq 0 ]; then DURATION=1; fi
            SPEED=$(echo "scale=2; $TEST_FILE_SIZE_MB / $DURATION" | bc)
            echo "‚úÖ SCP SIKERES ($DURATION m√°sodperc, ~${SPEED} MB/s)"
            SCP_SUCCESS=true
          else
            echo "‚ùå SCP SIKERTELEN"
            SCP_SUCCESS=false
          fi
          
          echo ""
          
          # === 5. RSYNC FELT√ñLT√âS ===
          echo "üîÑ 5. RSYNC felt√∂lt√©s teszt..."
          REMOTE_FILE_RSYNC="$REMOTE_DIR/rsync_test_$(date +%s).bin"
          
          START_TIME=$(date +%s)
          if rsync -az --quiet "$TEST_FILE" "$VPS_USER@$VPS_HOST:$REMOTE_FILE_RSYNC"; then
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            if [ $DURATION -eq 0 ]; then DURATION=1; fi
            SPEED=$(echo "scale=2; $TEST_FILE_SIZE_MB / $DURATION" | bc)
            echo "‚úÖ RSYNC SIKERES ($DURATION m√°sodperc, ~${SPEED} MB/s)"
            RSYNC_SUCCESS=true
          else
            echo "‚ùå RSYNC SIKERTELEN"
            RSYNC_SUCCESS=false
          fi
          
          echo ""
          
          # === 6. F√ÅJL ELLEN≈êRZ√âS ===
          echo "üîç 6. F√°jlok ellen≈ërz√©se a szerveren..."
          ssh "$VPS_USER@$VPS_HOST" "
            echo 'F√°jlok a szerveren:'
            ls -lh '$REMOTE_DIR'/*test*.bin 2>/dev/null || echo 'Nincsenek tesztf√°jlok'
            
            if [ -f '$REMOTE_FILE_SCP' ]; then
              echo 'SCP f√°jl m√©rete:'
              ls -lh '$REMOTE_FILE_SCP'
            fi
            
            if [ -f '$REMOTE_FILE_RSYNC' ]; then
              echo 'RSYNC f√°jl m√©rete:'
              ls -lh '$REMOTE_FILE_RSYNC'
            fi
          "
          
          echo ""
          
          # === 7. TAKAR√çT√ÅS ===
          echo "üßπ 7. Takar√≠t√°s..."
          # Lok√°lis f√°jl
          rm -f "$TEST_FILE"
          echo "‚úì Lok√°lis f√°jl t√∂r√∂lve"
          
          # T√°voli f√°jlok
          ssh "$VPS_USER@$VPS_HOST" "
            rm -f '$REMOTE_FILE_SCP' '$REMOTE_FILE_RSYNC' 2>/dev/null && \
            echo '‚úì T√°voli f√°jlok t√∂r√∂lve' || \
            echo '‚ö†Ô∏è  Nincsenek t√∂rlend≈ë f√°jlok'
          "
          
          echo ""
          
          # === 8. √ñSSZEFOGLAL√ì ===
          echo "üìä === TESZT EREDM√âNYEK √ñSSZEFOGLAL√ì ==="
          echo ""
          echo "SSH kapcsolat: ‚úÖ M≈∞K√ñDIK"
          echo "SCP felt√∂lt√©s: $(if [ "$SCP_SUCCESS" = "true" ]; then echo "‚úÖ SIKERES"; else echo "‚ùå SIKERTELEN"; fi)"
          echo "RSYNC felt√∂lt√©s: $(if [ "$RSYNC_SUCCESS" = "true" ]; then echo "‚úÖ SIKERES"; else echo "‚ùå SIKERTELEN"; fi)"
          echo ""
          echo "F√°jlm√©ret: ${TEST_FILE_SIZE_MB}MB"
          echo "Remote dir: $REMOTE_DIR"
          echo ""
          
          if [ "$SCP_SUCCESS" = "true" ] && [ "$RSYNC_SUCCESS" = "true" ]; then
            echo "üéâ MINDEN TESZT SIKERES!"
            echo ""
            echo "Az eredeti CI script kapcsol√≥d√°si inform√°ci√≥i helyesek."
            echo "SCP √©s RSYNC m≈±k√∂dnek a jelenlegi konfigur√°ci√≥val."
          elif [ "$SCP_SUCCESS" = "true" ] && [ "$RSYNC_SUCCESS" = "false" ]; then
            echo "‚ö†Ô∏è  FIGYELEM: Csak SCP m≈±k√∂dik"
            echo ""
            echo "RSYNC nem m≈±k√∂dik, de SCP igen."
            echo "Az eredeti CI script csak SCP-t haszn√°l, √≠gy m≈±k√∂dnie kell."
          elif [ "$SCP_SUCCESS" = "false" ] && [ "$RSYNC_SUCCESS" = "true" ]; then
            echo "‚ö†Ô∏è  FIGYELEM: Csak RSYNC m≈±k√∂dik"
            echo ""
            echo "Az eredeti CI script SCP-t haszn√°l, de az nem m≈±k√∂dik."
            echo "Javasolt az eredeti script SCP r√©sz√©nek jav√≠t√°sa."
          else
            echo "‚ùå EGYIK M√ìDSZER SEM M≈∞K√ñDIK"
            echo ""
            echo "Probl√©m√°k lehetnek:"
            echo "1. SSH kulcs hib√°s"
            echo "2. T≈±zfal blokkolja a kapcsolatot"
            echo "3. Remote k√∂nyvt√°r nem √≠rhat√≥"
          fi
          
          echo ""
          echo "üïí Teszt v√©ge: $(date)"
          echo "======================"