name: RSYNC Upload Test

on:
  workflow_dispatch:
    inputs:
      test_size_mb:
        description: 'Test file size in MB'
        default: '10'
        type: string

jobs:
  rsync-upload:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        env:
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          echo "=== KÖRNYEZET BEÁLLÍTÁSA ==="
          
          # Csak a szükséges csomagok
          pacman -Syu --noconfirm --needed git rsync openssh sudo
          
          # Builder user (pontosan ugyanúgy)
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # Git konfiguráció
          git config --system --add safe.directory '*'
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          
          # Jogosultságok
          chown -R builder:builder .
          
          echo "✅ Környezet kész"

      - name: Setup SSH for builder
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          echo "=== SSH BEÁLLÍTÁS ==="
          
          mkdir -p /home/builder/.ssh
          chmod 700 /home/builder/.ssh
          
          # SSH kulcs
          echo "${{ secrets.VPS_SSH_KEY }}" | base64 -d > /home/builder/.ssh/id_ed25519
          chmod 600 /home/builder/.ssh/id_ed25519
          
          # SSH config - NAGYON FONTOS!
          cat > /home/builder/.ssh/config << 'EOF'
          Host $VPS_HOST
            HostName $VPS_HOST
            User $VPS_USER
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
            ConnectTimeout 30
            ServerAliveInterval 15
            ServerAliveCountMax 3
          EOF
          
          # Változók behelyettesítése
          sed -i "s/\$VPS_HOST/$VPS_HOST/g" /home/builder/.ssh/config
          sed -i "s/\$VPS_USER/$VPS_USER/g" /home/builder/.ssh/config
          
          # Host key
          ssh-keyscan -H $VPS_HOST > /home/builder/.ssh/known_hosts 2>/dev/null
          
          # Jogosultságok
          chown -R builder:builder /home/builder/.ssh
          
          echo "SSH config:"
          cat /home/builder/.ssh/config
          echo ""
          echo "✅ SSH beállítva"

      - name: Run RSYNC upload test
        env:
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          TEST_SIZE_MB: ${{ github.event.inputs.test_size_mb }}
        run: |
          echo "=== RSYNC TESZT INDUL ==="
          
          # Átmásoljuk és futtatjuk a szkriptet builder userként
          cp ./.github/scripts/rsync-upload.sh /home/builder/rsync-upload.sh
          chmod +x /home/builder/rsync-upload.sh
          chown builder:builder /home/builder/rsync-upload.sh
          
          su builder -c "cd /home/builder && REMOTE_DIR='$REMOTE_DIR' VPS_USER='$VPS_USER' VPS_HOST='$VPS_HOST' TEST_SIZE_MB='$TEST_SIZE_MB' ./rsync-upload.sh"