name: Upload Test - Complete Environment

on:
  workflow_dispatch:
    inputs:
      test_file_size_mb:
        description: 'Test file size in MB'
        default: '5'
        type: string
      use_compression:
        description: 'Use compression for transfer'
        default: 'true'
        type: boolean

jobs:
  upload-test:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Test Environment
        run: |
          echo "=== TESZT KÃ–RNYEZET ELÅKÃ‰SZÃTÃ‰SE ==="
          echo "DÃ¡tum: $(date)"
          
          pacman-key --init
          pacman-key --populate archlinux
          
          pacman -Syu --noconfirm --needed \
            git rsync openssh \
            base-devel sudo coreutils \
            curl wget jq bc
          
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          git config --system --add safe.directory '*'
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          
          chown -R builder:builder .
          
          echo "=== RENDSZER INFORMÃCIÃ“ ==="
          echo "Hostname: $(hostname)"
          echo "SSH: $(ssh -V 2>&1)"
          echo "RSYNC: $(rsync --version | head -1)"

      - name: Setup SSH and Environment Variables
        env:
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          echo "=== KÃ–RNYEZETI VÃLTOZÃ“K BEÃLLÃTÃSA ==="
          
          echo "REMOTE_DIR: $REMOTE_DIR"
          echo "VPS_USER: $VPS_USER"
          echo "VPS_HOST: $VPS_HOST"
          
          if [ -z "$REMOTE_DIR" ] || [ -z "$VPS_USER" ] || [ -z "$VPS_HOST" ]; then
            echo "âŒ HIBA: Egy vagy tÃ¶bb secret nincs beÃ¡llÃ­tva!"
            echo "SzÃ¼ksÃ©ges secrets: REMOTE_DIR, VPS_USER, VPS_HOST, VPS_SSH_KEY"
            exit 1
          fi
          
          mkdir -p /home/builder/.ssh
          
          echo "${{ secrets.VPS_SSH_KEY }}" | base64 -d > /home/builder/.ssh/id_ed25519
          chmod 600 /home/builder/.ssh/id_ed25519
          
          echo "=== SSH KULCS INFO ==="
          ssh-keygen -l -f /home/builder/.ssh/id_ed25519
          
          # SSH config lÃ©trehozÃ¡sa - KIJAVÃTVA A SZINTAXIST
          cat > /home/builder/.ssh/config << 'EOF'
Host ${VPS_HOST}
    HostName ${VPS_HOST}
    User ${VPS_USER}
    IdentityFile ~/.ssh/id_ed25519
    StrictHostKeyChecking no
    ConnectTimeout 30
    ServerAliveInterval 15
    ServerAliveCountMax 3
    LogLevel DEBUG3
EOF
          
          # VÃ¡ltozÃ³k behelyettesÃ­tÃ©se
          sed -i "s/\${VPS_HOST}/$VPS_HOST/g" /home/builder/.ssh/config
          sed -i "s/\${VPS_USER}/$VPS_USER/g" /home/builder/.ssh/config
          
          echo "Adding host to known_hosts..."
          ssh-keyscan -H $VPS_HOST >> /home/builder/.ssh/known_hosts 2>/dev/null
          
          chown -R builder:builder /home/builder/.ssh
          
          # Environment vÃ¡ltozÃ³k fÃ¡jlba mentÃ©se
          cat > /home/builder/env_vars.sh << EOF
export REMOTE_DIR="$REMOTE_DIR"
export VPS_USER="$VPS_USER"
export VPS_HOST="$VPS_HOST"
export TEST_FILE_SIZE_MB="${{ github.event.inputs.test_file_size_mb }}"
export USE_COMPRESSION="${{ github.event.inputs.use_compression }}"
export BUILD_TIMESTAMP="\$(date +%s)"
export TEST_PREFIX="github_test_\${BUILD_TIMESTAMP}"
EOF
          
          chown builder:builder /home/builder/env_vars.sh
          
          echo "=== SSH BEÃLLÃTÃSOK KÃ‰SZ ==="
          echo "SSH config tartalma:"
          cat /home/builder/.ssh/config

      - name: Copy and Run Test Script
        env:
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          echo "=== TESZT SCRIPT BEÃLLÃTÃSA ==="
          
          # ÃtmÃ¡soljuk a szkriptet a builder home kÃ¶nyvtÃ¡rÃ¡ba
          cp ./.github/scripts/upload-test.sh /home/builder/upload-test.sh
          chmod +x /home/builder/upload-test.sh
          chown builder:builder /home/builder/upload-test.sh
          
          echo "Script mÃ¡solva Ã©s executable-re Ã¡llÃ­tva"
          echo "Script helye: /home/builder/upload-test.sh"
          
          # Environment vÃ¡ltozÃ³k Ã¡tadÃ¡sa
          export REMOTE_DIR="$REMOTE_DIR"
          export VPS_USER="$VPS_USER"
          export VPS_HOST="$VPS_HOST"
          export TEST_FILE_SIZE_MB="${{ github.event.inputs.test_file_size_mb }}"
          export USE_COMPRESSION="${{ github.event.inputs.use_compression }}"
          
          echo "=== TESZT SCRIPT INDUL ==="
          su builder -c "cd /home/builder && source env_vars.sh && ./upload-test.sh"

      - name: Generate Final Report
        if: always()
        run: |
          echo "=== VÃ‰GJELENTÃ‰S ==="
          echo ""
          echo "ðŸ“Š TESZT Ã–SSZEFOGLALÃ“"
          echo "====================="
          echo ""
          echo "âœ… ElvÃ©gzett tesztek:"
          echo "   - SSH kapcsolat ellenÅ‘rzÃ©se"
          echo "   - TÃ¡voli kÃ¶nyvtÃ¡r ellenÅ‘rzÃ©se"
          echo "   - SCP feltÃ¶ltÃ©s (tÃ¶bb fÃ¡jl)"
          echo "   - RSYNC feltÃ¶ltÃ©s (tÃ¶mÃ¶rÃ­tÃ©ssel)"
          echo "   - FÃ¡jlok ellenÅ‘rzÃ©se a szerveren"
          echo "   - Automatikus takarÃ­tÃ¡s"
          echo ""
          echo "ðŸ”§ HasznÃ¡lt technolÃ³giÃ¡k:"
          echo "   - SSH kulcs hitelesÃ­tÃ©s"
          echo "   - SCP fÃ¡jlÃ¡tvitel"
          echo "   - RSYNC szinkronizÃ¡ciÃ³"
          echo "   - TÃ¶mÃ¶rÃ­tÃ©s: ${{ github.event.inputs.use_compression }}"
          echo ""
          echo "ðŸ“ˆ TesztfÃ¡jl mÃ©retek:"
          echo "   - 5MB"
          echo "   - 190MB"
          echo "   - ${{ github.event.inputs.test_file_size_mb }}MB"
          echo ""
          echo "ðŸ” Secrets hasznÃ¡lat:"
          echo "   - REMOTE_DIR: ${{ secrets.REMOTE_DIR }}"
          echo "   - VPS_USER: ${{ secrets.VPS_USER }}"
          echo "   - VPS_HOST: ${{ secrets.VPS_HOST }}"
          echo "   - VPS_SSH_KEY: $(if [ -n "${{ secrets.VPS_SSH_KEY }}" ]; then echo "âœ“ BeÃ¡llÃ­tva"; else echo "âœ— HiÃ¡nyzik"; fi)"
          echo ""
          echo "=== TESZT VÃ‰GE ==="