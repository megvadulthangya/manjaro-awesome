name: Debug SSH Connection ONLY

on: 
  workflow_dispatch: # Csak gombnyomásra indul

jobs:
  debug-connection:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Install OpenSSH
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm openssh

      - name: Setup and Test SSH
        env:
          VPS_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          mkdir -p ~/.ssh
          
          echo "--- 1. DEKÓDOLÁS KEZDÉSE ---"
          # Base64 dekódolás
          echo "$VPS_KEY" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          echo "--- 2. KULCS ELLENŐRZÉSE (FEJLÉC) ---"
          # KIÍRJUK A KULCS ELSŐ 2 SORÁT. 
          # Ha itt értelmetlen betűhalmazt látsz a "-----BEGIN..." helyett, 
          # akkor a dekódolás nem sikerült!
          head -n 2 ~/.ssh/id_rsa
          echo "..."
          echo "-------------------------------------"

          echo "--- 3. KULCS TÍPUS ELLENŐRZÉSE ---"
          # Ez megmondja, mit gondol az SSH a fájlról (ez dobta a type -1 hibát)
          ssh-keygen -lf ~/.ssh/id_rsa || echo "HIBA: Az SSH nem ismeri fel a kulcsot!"
          
          echo "--- 4. KAPCSOLÓDÁSI TESZT ---"
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
          
          # verbose (-v) mód és RSA kényszerítés
          ssh -v -o StrictHostKeyChecking=no -o PubkeyAcceptedAlgorithms=+ssh-rsa $VPS_USER@$VPS_HOST "echo 'SIKERES CSATLAKOZÁS!'"
