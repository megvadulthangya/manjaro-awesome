name: Debug SSH Connection ONLY

on: 
  workflow_dispatch:

jobs:
  debug-connection:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Install OpenSSH
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm openssh

      - name: Setup and Test SSH
        env:
          VPS_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          mkdir -p ~/.ssh
          
          echo "--- 1. DEKÓDOLÁS (ED25519) ---"
          # Most már helyes néven mentjük
          echo "$VPS_KEY" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          echo "--- 2. KULCS TÍPUS ELLENŐRZÉSE ---"
          ssh-keygen -lf ~/.ssh/id_ed25519 || echo "HIBA: Az SSH nem ismeri fel a kulcsot!"
          
          echo "--- 3. KAPCSOLÓDÁSI TESZT ---"
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
          
          # TISZTA PARANCS: Nincs RSA kényszerítés, csak a kulcsot adjuk meg (-i)
          # A -v marad, hogy lássuk a logot
          ssh -v -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 $VPS_USER@$VPS_HOST "echo 'SIKERES CSATLAKOZÁS!'"
