name: Manjaro Repo Smart Builder

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. LÉPÉS: ELŐSZÖR TELEPÍTÜNK MINDENT (Hogy meglegyen az ssh-keyscan és a git)
      - name: Prepare Environment
        run: |
          # Frissítjük a kulcstartókat, hogy ne legyen gond az aláírásokkal
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm --needed git rsync openssh base-devel jq
          
          # Létrehozzuk a builder usert
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # Mivel a checkout rootként történt, visszaadjuk a jogokat a buildernek
          chown -R builder:builder .
          
          # Git beállítása, hogy a checkout után ne legyen gond a "not a git repository" hibával
          git config --global --add safe.directory '*'

      # 2. LÉPÉS: CSAK MOST ÁLLÍTJUK BE AZ SSH-T (Mert már van openssh)
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # DEBUG: Ellenőrizzük, hogy a kulcs formátuma helyes-e (nem írjuk ki a tartalmát!)
          echo "--- SSH KEY DEBUG INFO ---"
          echo "File exists: $(ls -l ~/.ssh/id_rsa)"
          echo "First line: $(head -n 1 ~/.ssh/id_rsa)"
          echo "Last line: $(tail -n 1 ~/.ssh/id_rsa)"
          echo "Total lines (should be > 1): $(wc -l < ~/.ssh/id_rsa)"
          echo "--------------------------"
          
          # Hozzáadjuk a szervert a known_hosts-hoz
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # 3. LÉPÉS: FUTTATÁS
      - name: Run Smart Build Script
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          chmod +x ./ci-smart-build.sh
          su builder -c ./ci-smart-build.sh
