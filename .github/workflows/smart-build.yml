name: Manjaro Repo Smart Builder

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Environment (Install Build Essentials)
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          
          # 1. Telepítjük a hiányzó eszközöket (Tilixhez, Grayjayhez, stb.)
          pacman -Syu --noconfirm --needed \
            git rsync openssh base-devel jq \
            appstream appstream-glib \
            rust cargo \
            meson ninja cmake \
            python \
            gtk3 gtk4 \
            imagemagick \
            po4a \
            bc \
            fontconfig \
            libxml2 \
            clang llvm lld
          
          # 2. DEBUG CSOMAGOK TILTÁSA (EZ A LÉNYEG!)
          # Megkeressük az OPTIONS sort a konfigban, és a 'debug'-ot átírjuk '!debug'-ra.
          # Így nem lesznek -debug végű kis fájlok, hanem egyetlen nagy, működő csomag lesz.
          sed -i '/^OPTIONS=/ s/ debug/ !debug/' /etc/makepkg.conf
          
          # + Biztosítjuk, hogy a tömörítés ZST legyen (gyorsabb és ez a szabvány)
          sed -i "s/^COMPRESSZST=.*/COMPRESSZST=(zstd -c -T0 --ultra -20 -)/" /etc/makepkg.conf

          # Felhasználó beállítása
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # Jogosultságok
          chown -R builder:builder .
          git config --system --add safe.directory '*'

      - name: Setup SSH for Builder
        run: |
          mkdir -p /home/builder/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" | base64 -d > /home/builder/.ssh/id_ed25519
          chmod 600 /home/builder/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> /home/builder/.ssh/known_hosts
          chown -R builder:builder /home/builder/.ssh

      - name: Debug Directory Structure
        run: |
          ls -la

      - name: Run Smart Build Script
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          chmod +x ./ci-smart-build.sh
          su builder -c ./ci-smart-build.sh
