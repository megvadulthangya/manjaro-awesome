name: Build and Deploy Manjaro Packages

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      OUTPUT_DIR: /home/builder/output
      REPO_NAME: manjaro-awesome
      AUR_PACKAGES: raw-thumbnailer

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup build environment
        run: |
          sudo apt update
          sudo apt install -y git makepkg base-devel

      - name: Create output directory
        run: mkdir -p $OUTPUT_DIR

      - name: Build packages
        run: |
          # Példa build lépés, itt a PKGBUILD-eket kell építeni
          # Minden build artifact ide kerül:
          # /home/builder/output
          for pkg in awesome-copycats-manjaro awesome-rofi nordic-backgrounds; do
            mkdir -p temp_build
            cp -r packages/$pkg/* temp_build/
            cd temp_build
            makepkg -o -p PKGBUILD -d || true  # '-o' csak az outputot készíti
            cp *tar.zst $OUTPUT_DIR/ || true
            cd ..
            rm -rf temp_build
          done

      - name: Check output
        run: |
          if [ ! -d "$OUTPUT_DIR" ] || [ -z "$(ls -A $OUTPUT_DIR)" ]; then
            echo "❌ Output directory is empty!"
            exit 1
          else
            echo "✅ Output directory has files:"
            ls -l $OUTPUT_DIR
          fi

      - name: Deploy to gh-pages
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"

          # Új orphan branch a gh-pages-hez
          git checkout --orphan gh-pages

          # Törlés mindenből, ami a fő branch-en van
          git rm -rf .

          # Másolás a build artifactokból
          cp -r $OUTPUT_DIR/* .

          git add .
          git commit -m "Update Manjaro repo"
          git push -f origin gh-pages
