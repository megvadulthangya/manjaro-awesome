name: Build Manjaro Repository

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y arch-install-scripts git wget

    - name: Create non-root build user
      run: |
        sudo useradd -m builder
        sudo passwd -d builder
        sudo bash -c "echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers"

    - name: Install Arch bootstrap to build the packages
      run: |
        wget https://mirror.rackspace.com/archlinux/iso/latest/archlinux-bootstrap-x86_64.tar.gz
        sudo tar xzf archlinux-bootstrap-x86_64.tar.gz -C /opt
        sudo mv /opt/archlinux-bootstrap-* /opt/arch
        sudo sed -i 's/#Server/Server/g' /opt/arch/etc/pacman.d/mirrorlist
        sudo mount --bind /opt/arch /opt/arch
        sudo cp -r . /opt/arch/root/project

    - name: Build packages inside Arch chroot
      run: |
        sudo arch-chroot /opt/arch /bin/bash -c "
          pacman -Sy --noconfirm base-devel git
          useradd -m builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          cd /root/project
          mkdir /root/output

          for PKG in \$(find . -maxdepth 2 -name PKGBUILD -exec dirname {} \;); do
            echo 'Building: ' \$PKG
            cd \$PKG
            sudo -u builder makepkg --noconfirm --clean --syncdeps
            mv *.pkg.tar.zst /root/output/
            cd /root/project
          done
        "

    - name: Upload repo artifacts
      uses: actions/upload-artifact@v4
      with:
        name: built-packages
        path: /opt/arch/root/output/
