name: Build Manjaro Packages

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  generate-packages:
    runs-on: ubuntu-latest
    outputs:
      custom_matrix: ${{ steps.set-matrix.outputs.custom_matrix }}
      aur_matrix: ${{ steps.set-matrix.outputs.aur_matrix }}
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: pip install pyyaml requests
        
    - name: Generate PKGBUILDs
      run: python3 scripts/generate-pkgbuild.py
        
    - name: Set build matrices
      id: set-matrix
      run: |
        # Egyszerű megoldás - fix értékek
        CUSTOM_MATRIX='{"include":[{"name":"nordic-backgrounds"},{"name":"awesome-rofi-themes"},{"name":"awesome-copycats"}]}'
        AUR_MATRIX='{"include":[{"name":"raw-thumbnailer"},{"name":"grayjay-bin"},{"name":"gsconnect"},{"name":"lain-git"},{"name":"awesome-git"},{"name":"awesome-freedesktop-git"},{"name":"tilix-git"},{"name":"ttf-font-awesome-5"},{"name":"tamzen-font"},{"name":"i3lock-fancy-git"},{"name":"betterlockscreen"},{"name":"nordic-theme"},{"name":"nordic-darker-theme"},{"name":"nordic-darker-standard-buttons-theme"},{"name":"nordic-polar-standard-buttons-theme"},{"name":"nordic-standard-buttons-theme"},{"name":"nordic-bluish-accent-theme"},{"name":"nordic-bluish-accent-standard-buttons-theme"},{"name":"geany-nord-theme"},{"name":"nordzy-icon-theme"},{"name":"oh-my-posh-bin"},{"name":"fish-done"},{"name":"find-the-command"},{"name":"p7zip-gui"}]}'
        
        echo "custom_matrix=$CUSTOM_MATRIX" >> $GITHUB_OUTPUT
        echo "aur_matrix=$AUR_MATRIX" >> $GITHUB_OUTPUT

  build-custom-packages:
    needs: generate-packages
    runs-on: ubuntu-latest
    container:
      image: manjarolinux/base:latest
    
    strategy:
      matrix: ${{ fromJson(needs.generate-packages.outputs.custom_matrix) }}
    
    steps:
    - name: Update Manjaro system
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm manjaro-release
        
    - name: Install build dependencies
      run: |
        pacman -S --noconfirm base-devel git sudo
        
    - name: Create build user
      run: |
        useradd -m builder
        echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
        
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Build custom package
      run: |
        cd packages/${{ matrix.name }}
        sudo -u builder bash -c "makepkg -s --noconfirm"
        
    - name: Upload custom package artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}-custom-pkg
        path: packages/${{ matrix.name }}/*.pkg.tar.*

  build-aur-packages:
    needs: generate-packages
    runs-on: ubuntu-latest
    container:
      image: manjarolinux/base:latest
    
    strategy:
      matrix: ${{ fromJson(needs.generate-packages.outputs.aur_matrix) }}
    
    steps:
    - name: Update Manjaro system
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm manjaro-release
        
    - name: Install build dependencies
      run: |
        pacman -S --noconfirm base-devel git sudo
        
    - name: Create build user
      run: |
        useradd -m builder
        echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
        
    - name: Install paru AUR helper
      run: |
        cd /tmp
        sudo -u builder git clone https://aur.archlinux.org/paru-bin.git
        cd paru-bin
        sudo -u builder makepkg -si --noconfirm --skippgpcheck
        
    - name: Build AUR package
      run: |
        sudo -u builder bash -c "cd /tmp && paru -S --noconfirm --builddir /tmp/aur-build ${{ matrix.name }} --skipreview"
        find /tmp/aur-build -name "*.pkg.tar.*" -exec cp {} . \;
        
    - name: Upload AUR package artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}-aur-pkg
        path: "*.pkg.tar.*"

  create-repository:
    needs: [build-custom-packages, build-aur-packages]
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Set up repository structure
      run: |
        mkdir -p repo
        find . -name "*.pkg.tar.*" -exec cp {} repo/ \;
        
    - name: Create repository database
      run: |
        cd repo
        tar -czf manjaro-awesome-nord.db.tar.gz *.pkg.tar.* || true
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./repo
        force_orphan: true