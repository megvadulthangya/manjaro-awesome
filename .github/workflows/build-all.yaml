name: Build Manjaro Packages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Csak 3 custom package kezdésnek
          - { name: nordic-backgrounds, type: custom }
          - { name: awesome-rofi, type: custom }
          - { name: awesome-copycats-manjaro, type: custom }
          # Csak 3 AUR package kezdésnek
          - { name: nordic-theme, type: aur }
          - { name: betterlockscreen, type: aur }
          - { name: nordzy-icon-theme, type: aur }

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build custom package
      if: matrix.type == 'custom'
      run: |
        echo "Building custom package: ${{ matrix.name }}"
        # Generate PKGBUILD first
        python3 scripts/generate-single-pkgbuild.py ${{ matrix.name }}
        
        # Then build in Docker
        docker run --rm -v $PWD:/workspace -w /workspace manjarolinux/base:latest /bin/bash -c "
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git sudo
          useradd -m builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          cd packages/${{ matrix.name }}
          ls -la
          cat PKGBUILD
          sudo -u builder makepkg -s --noconfirm --skippgpcheck
          cp *.pkg.tar.* /workspace/
        "

    - name: Build AUR package
      if: matrix.type == 'aur'
      run: |
        echo "Building AUR package: ${{ matrix.name }}"
        docker run --rm -v $PWD:/workspace -w /workspace archlinux:latest /bin/bash -c "
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git sudo
          useradd -m builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          cd /tmp
          sudo -u builder git clone https://aur.archlinux.org/yay-bin.git
          cd yay-bin
          sudo -u builder makepkg -si --noconfirm --skippgpcheck
          cd /workspace
          sudo -u builder bash -c 'yay -S --noconfirm --builddir /tmp/aur-build ${{ matrix.name }} --answerclean All --answerdiff None --answeredit None --removemake --noconfirm 2>&1 | tee build.log'
          find /tmp/aur-build -name \"*.pkg.tar.*\" -exec cp {} /workspace/ \;
          echo 'Build completed. Files:'
          ls -la /workspace/*.pkg.tar.* 2>/dev/null || echo 'No package files found'
        "

    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}-pkg
        path: "*.pkg.tar.*"

  create-repository:
    needs: build-packages
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create repository structure
      run: |
        mkdir -p repo
        find . -name "*.pkg.tar.*" -exec cp {} repo/ \;
        echo "Repository contents:"
        ls -la repo/ || echo "No packages found"

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./repo
        force_orphan: true