name: Build Manjaro Packages

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  generate-packages:
    runs-on: ubuntu-latest
    outputs:
      custom_matrix: ${{ steps.set-matrix.outputs.custom_matrix }}
      aur_matrix: ${{ steps.set-matrix.outputs.aur_matrix }}
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: pip install pyyaml requests
        
    - name: Generate PKGBUILDs
      run: python3 scripts/generate-pkgbuild.py
        
    - name: Set build matrices
      id: set-matrix
      run: |
        # Custom packages matrix
        CUSTOM_PACKAGES=$(find packages -name PKGBUILD -type f | sed 's|/PKGBUILD||' | sed 's|packages/||' | jq -R -s -c 'split("\n") | map(select(. != ""))')
        echo "custom_matrix={\"include\":$(echo $CUSTOM_PACKAGES | jq 'map({name: .})')}" >> $GITHUB_OUTPUT
        
        # AUR packages matrix
        AUR_PACKAGES='["raw-thumbnailer", "grayjay-bin", "gsconnect", "lain-git", "awesome-git", "awesome-freedesktop-git", "tilix-git", "ttf-font-awesome-5", "tamzen-font", "i3lock-fancy-git", "betterlockscreen", "nordic-theme", "nordic-darker-theme", "nordic-darker-standard-buttons-theme", "nordic-polar-standard-buttons-theme", "nordic-standard-buttons-theme", "nordic-bluish-accent-theme", "nordic-bluish-accent-standard-buttons-theme", "geany-nord-theme", "nordzy-icon-theme", "oh-my-posh-bin", "fish-done", "find-the-command", "p7zip-gui"]'
        echo "aur_matrix=$AUR_PACKAGES" >> $GITHUB_OUTPUT

  build-custom-packages:
    needs: generate-packages
    runs-on: ubuntu-latest
    container:
      image: manjarolinux/base:latest
    
    strategy:
      matrix: ${{ fromJson(needs.generate-packages.outputs.custom_matrix) }}
    
    steps:
    - name: Update Manjaro system
      run: |
        pacman -Syu --noconfirm
        # Manjaro specifikus beállítások
        pacman -S --noconfirm manjaro-release
        
    - name: Install build dependencies
      run: |
        pacman -S --noconfirm base-devel git sudo
        
    - name: Create build user
      run: |
        useradd -m builder
        echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
        
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Build custom package
      run: |
        cd packages/${{ matrix.name }}
        sudo -u builder bash -c "makepkg -s --noconfirm"
        
    - name: Upload custom package artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}-custom-pkg
        path: packages/${{ matrix.name }}/*.pkg.tar.*

  build-aur-packages:
    needs: generate-packages
    runs-on: ubuntu-latest
    container:
      image: manjarolinux/base:latest
    
    strategy:
      matrix: 
        name: ${{ fromJson(needs.generate-packages.outputs.aur_matrix) }}
    
    steps:
    - name: Update Manjaro system
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm manjaro-release
        
    - name: Install build dependencies
      run: |
        pacman -S --noconfirm base-devel git sudo awk
        
    - name: Create build user
      run: |
        useradd -m builder
        echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
        
    - name: Install paru AUR helper (Manjaro kompatibilis verzió)
      run: |
        cd /tmp
        # Használjunk egy stabil paru verziót
        sudo -u builder git clone https://aur.archlinux.org/paru-bin.git
        cd paru-bin
        sudo -u builder makepkg -si --noconfirm --skippgpcheck
        
    - name: Build AUR package
      run: |
        # Manjaro specifikus AUR build
        sudo -u builder bash -c "cd /tmp && paru -S --noconfirm --builddir /tmp/aur-build ${{ matrix.name }} --skipreview"
        
        # Find and copy the built package
        find /tmp/aur-build -name "*.pkg.tar.*" -exec cp {} . \;
        
    - name: Upload AUR package artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}-aur-pkg
        path: "*.pkg.tar.*"

  create-repository:
    needs: [build-custom-packages, build-aur-packages]
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Set up repository structure
      run: |
        mkdir -p repo
        # Összes csomag másolása a repo mappába
        find . -name "*.pkg.tar.*" -exec cp {} repo/ \;
        
    - name: Install pacman tools (Alpine Linux-on)
      run: |
        apk update
        apk add libarchive-tools bash
        
    - name: Create repository database
      run: |
        cd repo
        # Create package database
        repo-add manjaro-awesome-nord.db.tar.gz *.pkg.tar.*
        
    - name: Verify Manjaro compatibility
      run: |
        cd repo
        echo "Ellenőrzöm a csomagok Manjaro kompatibilitását..."
        for pkg in *.pkg.tar.*; do
          echo "Csomag: $pkg"
          # Egyszerű kompatibilitás ellenőrzés
          tar -tf "$pkg" | grep -q "etc/calamares" && echo "  - Tartalmaz Calamares fájlokat" || true
        done
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./repo
        force_orphan: true