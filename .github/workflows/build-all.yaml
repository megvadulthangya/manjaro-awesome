name: Build and Deploy

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build package
      run: |
        # Create PKGBUILD
        mkdir -p /tmp/pkgbuild
        cat > /tmp/pkgbuild/PKGBUILD << 'EOF'
pkgname=nordic-backgrounds-test
pkgver=1.0.0
pkgrel=1
pkgdesc="Test package for nordic backgrounds"
arch=('any')

package() {
  echo "This is a test package"
}
EOF

        # Build in container
        docker run --rm \
          -v /tmp/pkgbuild:/build \
          -w /build \
          manjarolinux/base:latest \
          bash -c "
            pacman -Syu --noconfirm
            pacman -S --noconfirm base-devel
            useradd -m builder
            su - builder -c 'cd /build && makepkg'
            ls -la *.pkg.tar.*
          "
        
        # Check result
        if ls /tmp/pkgbuild/*.pkg.tar.* 1>/dev/null 2>&1; then
          echo "✅ TEST SUCCESS - Package was built!"
          mkdir -p repo
          cp /tmp/pkgbuild/*.pkg.tar.* repo/
          ls -la repo/
        else
          echo "❌ TEST FAILED - No package created"
          exit 1
        fi

    - name: Deploy
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./repo
        force_orphan: true