name: Build Manjaro Packages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      custom_matrix: ${{ steps.matrix.outputs.custom }}
      aur_matrix: ${{ steps.matrix.outputs.aur }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Generate matrix from YAML
        id: matrix
        run: |
          python3 << 'EOF'
          import yaml
          import json
          import os
          
          with open('projects.yaml', 'r') as f:
              config = yaml.safe_load(f)
          
          # Custom packages matrix
          custom_packages = config.get('custom_packages', [])
          custom_matrix = [{'name': pkg['name'], 'type': 'custom'} for pkg in custom_packages]
          
          # AUR packages matrix  
          aur_packages = config.get('aur_packages', [])
          aur_matrix = [{'name': pkg, 'type': 'aur'} for pkg in aur_packages]
          
          # Output matrices
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'custom={json.dumps(custom_matrix)}\n')
              f.write(f'aur={json.dumps(aur_matrix)}\n')
          
          print("Generated matrices:")
          print(f"Custom: {len(custom_matrix)} packages")
          print(f"AUR: {len(aur_matrix)} packages")
          EOF

  build-packages:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.custom_matrix) }} + ${{ fromJson(needs.generate-matrix.outputs.aur_matrix) }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build custom package
      if: matrix.type == 'custom'
      run: |
        docker run --rm -v $PWD:/workspace -w /workspace manjarolinux/base:latest /bin/bash -c "
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git sudo python python-pip
          pip install pyyaml requests
          useradd -m builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          python3 scripts/generate-single-pkgbuild.py ${{ matrix.name }}
          cd packages/${{ matrix.name }}
          sudo -u builder makepkg -s --noconfirm --skippgpcheck
          cp *.pkg.tar.* /workspace/
        "

    - name: Build AUR package
      if: matrix.type == 'aur'
      run: |
        docker run --rm -v $PWD:/workspace -w /workspace archlinux:latest /bin/bash -c "
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git sudo
          useradd -m builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          cd /tmp
          sudo -u builder git clone https://aur.archlinux.org/yay-bin.git
          cd yay-bin
          sudo -u builder makepkg -si --noconfirm --skippgpcheck
          cd /workspace
          sudo -u builder bash -c 'yay -S --noconfirm --builddir /tmp/aur-build ${{ matrix.name }} --answerclean All --answerdiff None --answeredit None --removemake --noconfirm'
          find /tmp/aur-build -name \"*.pkg.tar.*\" -exec cp {} /workspace/ \;
        "

    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}-${{ matrix.type }}-pkg
        path: "*.pkg.tar.*"

  create-repository:
    needs: build-packages
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create repository structure
      run: |
        mkdir -p repo
        find . -name "*.pkg.tar.*" -exec cp {} repo/ \;
        echo "Packages in repository:"
        ls -la repo/ || echo "No packages found"

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./repo
        force_orphan: true