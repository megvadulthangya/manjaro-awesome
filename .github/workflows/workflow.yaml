name: Manjaro Package Builder

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Environment
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm --needed \
            git base-devel sudo \
            python python-pip \
            pacman-contrib
          
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .
          
          # Optimize makepkg
          sed -i '/^OPTIONS=/ s/ debug/ !debug/' /etc/makepkg.conf

      - name: Setup SSH
        run: |
          mkdir -p /home/builder/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > /home/builder/.ssh/id_ed25519
          chmod 600 /home/builder/.ssh/id_ed25519
          chown -R builder:builder /home/builder/.ssh

      - name: Run Builder
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          chmod +x builder.py
          su builder -c "python3 builder.py"