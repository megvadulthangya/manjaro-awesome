name: Manjaro Package Builder

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'  # Daily at 4 AM UTC

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for git operations

      - name: Prepare Environment
        run: |
          # Initialize pacman
          pacman-key --init
          pacman-key --populate archlinux
          
          
          # Telepítsük a Python modulokat pacman-al is
          pacman -Syu --noconfirm --needed \
            git base-devel sudo \
            python python-pip \
            python-requests python-gitpython python-yaml \
            pacman-contrib \
            curl wget ca-certificates \
            openssh \
            rsync
          
          # Ha még nem lenne elég, pip-el is
          pip install --upgrade pip
          pip install requests gitpython pyyaml        
          
          
          
          # Create builder user
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # Git safety settings
          git config --system --add safe.directory '*'
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          
          # Set ownership
          chown -R builder:builder .
          
          # Optimize makepkg
          sed -i '/^OPTIONS=/ s/ debug/ !debug/' /etc/makepkg.conf
          sed -i "s/^COMPRESSZST=.*/COMPRESSZST=(zstd -c -T0 --ultra -20 -)/" /etc/makepkg.conf
          
          echo "Environment preparation complete"

      - name: Setup SSH
        run: |
          mkdir -p /home/builder/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > /home/builder/.ssh/id_ed25519
          chmod 600 /home/builder/.ssh/id_ed25519
          
          # Add known hosts
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> /home/builder/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H github.com >> /home/builder/.ssh/known_hosts 2>/dev/null || true
          
          chown -R builder:builder /home/builder/.ssh
          echo "SSH setup complete"

      - name: Verify Python Environment
        run: |
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
          python -c "import requests; print('✓ requests module available')"
          python -c "import git; print('✓ gitpython module available')"
          python -c "import yaml; print('✓ pyyaml module available')"

      - name: Run Builder
        env:
          # SSH Connection
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          
          # Repository Configuration
          REPO_SERVER_URL: ${{ secrets.REPO_SERVER_URL }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          REPO_NAME: ${{ secrets.REPO_NAME || 'manjaro-awesome' }}
        run: |
          # Make script executable
          chmod +x builder.py
          
          # First, test that we can run Python
          echo "Testing Python script..."
          python -c "print('Python is working')"
          
          # Run as builder user
          echo "Starting builder script..."
          su builder -c "cd $PWD && python3 builder.py"
          
          # Check if log was created
          if [ -f "builder.log" ]; then
            echo "Builder log created:"
            tail -20 builder.log
          else
            echo "No builder.log found"
          fi

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-results
          path: |
            builder.log
            built_packages/
            .buildtracking/
          retention-days: 7
