name: Manjaro Package Builder

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'  # Daily at 4 AM UTC

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --network host

    env:
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      REPO_SERVER_URL: ${{ secrets.REPO_SERVER_URL }}
      REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
      REPO_NAME: ${{ secrets.REPO_NAME || 'manjaro-awesome' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Environment
        run: |
          echo "=== Starting Environment Preparation ==="
          echo "Repository: $REPO_NAME"
          echo "Server URL: $REPO_SERVER_URL"
          
          pacman-key --init
          pacman-key --populate archlinux
          
          pacman -Syu --noconfirm --needed \
            git base-devel sudo \
            python python-pip \
            python-requests python-gitpython python-yaml python-setuptools \
            pacman-contrib \
            curl wget ca-certificates \
            openssh rsync \
            appstream appstream-glib \
            meson ninja cmake \
            gtk-doc docbook-xsl libxslt \
            gobject-introspection \
            autoconf automake libtool pkg-config \
            patch make gcc binutils \
            file which tar gzip bzip2 xz zstd \
            unzip p7zip gnupg \
            dbus polkit \
            systemd systemd-sysvcompat \
            arch-install-scripts
            
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          git config --system --add safe.directory '*'
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          
          chown -R builder:builder "$(pwd)"
          
          sed -i '/^OPTIONS=/ s/ debug/ !debug/' /etc/makepkg.conf
          sed -i "s/^COMPRESSZST=.*/COMPRESSZST=(zstd -c -T0 --ultra -20 -)/" /etc/makepkg.conf
          
          echo "âœ… Environment preparation complete"

      - name: Setup SSH
        run: |
          echo "=== Current environment variables ==="
          env | grep -E "VPS|REPO|REMOTE" || echo "No VPS/REPO env vars found"
          echo ""
          
          mkdir -p /home/builder/.ssh
          chmod 700 /home/builder/.ssh
          
          echo "=== Checking SSH key ==="
          if [ -z "$VPS_SSH_KEY" ]; then
            echo "âŒ ERROR: VPS_SSH_KEY is empty!"
            exit 1
          else
            echo "âœ… SSH key is set (length: ${#VPS_SSH_KEY} chars)"
          fi
          
          echo "=== Writing SSH key ==="
          if echo "$VPS_SSH_KEY" | base64 -d >/dev/null 2>&1; then
            echo "ðŸ”‘ Key appears to be base64 encoded, decoding..."
            echo "$VPS_SSH_KEY" | base64 -d > /home/builder/.ssh/id_ed25519
            echo "âœ… Key decoded from base64"
          else
            echo "ðŸ”‘ Key is plain text, writing as-is..."
            echo "$VPS_SSH_KEY" > /home/builder/.ssh/id_ed25519
            echo "âœ… Key written as plain text"
          fi
          
          chmod 600 /home/builder/.ssh/id_ed25519
          
          # Create SSH config without heredoc - using echo statements
          echo "Creating SSH config..."
          echo "Host $VPS_HOST" > /home/builder/.ssh/config
          echo "  HostName $VPS_HOST" >> /home/builder/.ssh/config
          echo "  User $VPS_USER" >> /home/builder/.ssh/config
          echo "  IdentityFile ~/.ssh/id_ed25519" >> /home/builder/.ssh/config
          echo "  Port 22" >> /home/builder/.ssh/config
          echo "  ConnectTimeout 30" >> /home/builder/.ssh/config
          echo "  ServerAliveInterval 60" >> /home/builder/.ssh/config
          echo "  ServerAliveCountMax 3" >> /home/builder/.ssh/config
          echo "  TCPKeepAlive yes" >> /home/builder/.ssh/config
          echo "  ControlMaster auto" >> /home/builder/.ssh/config
          echo "  ControlPath ~/.ssh/control-%r@%h:%p" >> /home/builder/.ssh/config
          echo "  ControlPersist 10m" >> /home/builder/.ssh/config
          
          chmod 600 /home/builder/.ssh/config
          
          echo "=== Adding known hosts ==="
          if [ -n "$VPS_HOST" ]; then
            echo "Adding $VPS_HOST..."
            ssh-keyscan -H "$VPS_HOST" > /home/builder/.ssh/known_hosts 2>/dev/null
            if [ $? -eq 0 ]; then
              echo "âœ… SSH key for $VPS_HOST added to known_hosts"
            else
              echo "âš ï¸ Failed to get key for $VPS_HOST, trying with -t rsa,ecdsa,ed25519..."
              ssh-keyscan -t rsa,ecdsa,ed25519 -H "$VPS_HOST" >> /home/builder/.ssh/known_hosts 2>/dev/null
            fi
          else
            echo "âš ï¸ VPS_HOST is empty!"
          fi
          
          echo "Adding github.com..."
          ssh-keyscan -H github.com >> /home/builder/.ssh/known_hosts 2>/dev/null
          
          chown -R builder:builder /home/builder/.ssh
          
          echo "=== Testing SSH connection ==="
          echo "Testing connection to $VPS_USER@$VPS_HOST..."
          
          echo "1. Testing TCP connectivity to $VPS_HOST:22..."
          if timeout 5 nc -z -w 2 "$VPS_HOST" 22; then
            echo "âœ… TCP port 22 is accessible"
          else
            echo "âŒ Cannot reach $VPS_HOST on port 22"
            echo "This suggests a network/firewall issue"
          fi
          
          echo "2. Testing SSH connection..."
          su builder -c "ssh -o ConnectTimeout=10 -o BatchMode=yes -v $VPS_USER@$VPS_HOST 'echo SSH_TEST_OK'" 2>&1 | head -50
          
          echo "âœ… SSH setup complete"

      - name: Configure Pacman Repository
        run: |
          echo "=== Configuring Pacman Repository ==="
          echo "Repository: $REPO_NAME"
          echo "Server URL: $REPO_SERVER_URL"
          echo ""
          
          if [ -z "$REPO_NAME" ] || [ -z "$REPO_SERVER_URL" ]; then
            echo "âŒ ERROR: REPO_NAME or REPO_SERVER_URL is empty!"
            exit 1
          fi
          
          cp /etc/pacman.conf /etc/pacman.conf.backup
          
          if grep -q "^\[$REPO_NAME\]" /etc/pacman.conf; then
            echo "âš ï¸ Repository '$REPO_NAME' already exists in pacman.conf"
            echo "Updating server URL if needed..."
            
            sed -i "/\[$REPO_NAME\]/,/^\[/ s|^Server = .*|Server = $REPO_SERVER_URL|" /etc/pacman.conf
          else
            echo "âž• Adding repository '$REPO_NAME' to pacman.conf"
            
            echo "Creating repository configuration..."
            
            TEMP_FILE=$(mktemp)
            echo "[$REPO_NAME]" > "$TEMP_FILE"
            echo "Server = $REPO_SERVER_URL" >> "$TEMP_FILE"
            echo "SigLevel = Optional TrustAll" >> "$TEMP_FILE"
            
            if grep -q "^\[community\]" /etc/pacman.conf; then
              echo "Inserting before [community] section..."
              LINE_NUM=$(grep -n "^\[community\]" /etc/pacman.conf | cut -d: -f1)
              head -n $((LINE_NUM-1)) /etc/pacman.conf > /etc/pacman.conf.tmp
              cat "$TEMP_FILE" >> /etc/pacman.conf.tmp
              tail -n +$LINE_NUM /etc/pacman.conf >> /etc/pacman.conf.tmp
              mv /etc/pacman.conf.tmp /etc/pacman.conf
            else
              echo "Appending at end of file..."
              cat "$TEMP_FILE" >> /etc/pacman.conf
            fi
            
            rm -f "$TEMP_FILE"
          fi
          
          echo "=== Pacman.conf repository section ==="
          grep -A 2 "^\[$REPO_NAME\]" /etc/pacman.conf || echo "âŒ Repository not found in pacman.conf"
          
          echo ""
          echo "=== Context around repository in pacman.conf ==="
          grep -n -B 2 -A 2 "^\[$REPO_NAME\]" /etc/pacman.conf || echo "No context found"
          
          echo ""
          echo "Updating pacman database..."
          if pacman -Sy --noconfirm; then
            echo "âœ… Pacman database synchronized"
            
            echo ""
            echo "=== Testing repository access ==="
            if pacman -Sl "$REPO_NAME" >/dev/null 2>&1; then
              echo "âœ… Repository '$REPO_NAME' is accessible via pacman"
              echo "Available packages in repository:"
              pacman -Sl "$REPO_NAME" | head -10
            else
              echo "âš ï¸ Repository '$REPO_NAME' found but not accessible via pacman"
            fi
          else
            echo "âŒ Failed to sync pacman database"
            echo "Check /etc/pacman.conf for syntax errors"
            echo "Last 10 lines of pacman.conf:"
            tail -10 /etc/pacman.conf
          fi
          
          echo "âœ… Pacman repository configuration complete"

      - name: Verify Network Connectivity
        run: |
          echo "=== Network Connectivity Tests ==="
          
          echo "1. Testing internet connectivity..."
          if ping -c 2 8.8.8.8 >/dev/null 2>&1; then
            echo "âœ… Internet connectivity OK"
          else
            echo "âŒ No internet connectivity"
          fi
          
          echo ""
          echo "2. Testing SSH connectivity to $VPS_HOST..."
          if [ -n "$VPS_HOST" ] && [ -n "$VPS_USER" ]; then
            echo "Testing connection to $VPS_USER@$VPS_HOST..."
            
            echo "Resolving $VPS_HOST..."
            if getent hosts "$VPS_HOST" >/dev/null 2>&1; then
              echo "âœ… Hostname resolves: $(getent hosts $VPS_HOST)"
            else
              echo "âŒ Cannot resolve hostname $VPS_HOST"
            fi
            
            echo "Attempting SSH connection (verbose mode)..."
            timeout 15 ssh -vvv -o ConnectTimeout=10 -o BatchMode=yes "$VPS_USER@$VPS_HOST" "echo SSH_TEST_SUCCESS" 2>&1 | grep -A5 -B5 "timeout\|connected\|refused\|denied\|Connection to" || true
            
            if timeout 10 ssh -o ConnectTimeout=5 -o BatchMode=yes "$VPS_USER@$VPS_HOST" "echo SSH_TEST_OK" 2>/dev/null; then
              echo "âœ… SSH connection successful"
            else
              echo "âŒ SSH connection failed"
              echo "Debug info:"
              echo "  VPS_HOST: $VPS_HOST"
              echo "  VPS_USER: $VPS_USER"
              echo "  SSH key exists: $(ls -la /home/builder/.ssh/id_ed25519 2>/dev/null && echo 'Yes' || echo 'No')"
              echo "  SSH key permissions: $(stat -c '%a %n' /home/builder/.ssh/id_ed25519 2>/dev/null || echo 'N/A')"
              
              echo "  SSH config:"
              cat /home/builder/.ssh/config 2>/dev/null || echo "    No SSH config found"
              
              echo "  Known hosts for $VPS_HOST:"
              grep "$VPS_HOST" /home/builder/.ssh/known_hosts 2>/dev/null || echo "    Not in known_hosts"
            fi
          else
            echo "âš ï¸ VPS_HOST or VPS_USER not set"
          fi
          
          echo ""
          echo "3. Testing repository server $REPO_SERVER_URL..."
          if [ -n "$REPO_SERVER_URL" ]; then
            REPO_HOST=$(echo "$REPO_SERVER_URL" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
            echo "Testing connection to $REPO_HOST..."
            if timeout 5 curl -I "$REPO_SERVER_URL" >/dev/null 2>&1; then
              echo "âœ… Repository server reachable"
            else
              echo "âŒ Repository server not reachable"
            fi
          fi
          
          echo "âœ… Network tests complete"

      - name: Run Builder
        run: |
          chmod +x builder.py
          
          echo "=== Current Environment in Builder Step ==="
          echo "PWD: $(pwd)"
          echo "VPS_USER: $VPS_USER"
          echo "VPS_HOST: $VPS_HOST"
          echo "REPO_NAME: $REPO_NAME"
          echo "REPO_SERVER_URL: $REPO_SERVER_URL"
          echo "REMOTE_DIR: $REMOTE_DIR"
          echo ""
          
          echo "=== SSH Configuration ==="
          ls -la /home/builder/.ssh/
          echo "SSH config:"
          cat /home/builder/.ssh/config 2>/dev/null || echo "No SSH config"
          echo ""
          
          echo "=== Pre-build SSH Test ==="
          su builder -c "ssh -o ConnectTimeout=10 $VPS_USER@$VPS_HOST 'echo PRE_BUILD_SSH_TEST_OK && hostname'" && echo "âœ… SSH test successful" || echo "âŒ SSH test failed"
          echo ""
          
          echo "=== Builder Script Info ==="
          head -20 builder.py
          echo ""
          
          echo "=== Testing repository access ==="
          if pacman -Sl "$REPO_NAME" >/dev/null 2>&1; then
            echo "âœ… Repository '$REPO_NAME' is accessible via pacman"
            echo "Available packages in repository:"
            pacman -Sl "$REPO_NAME" | head -20
          else
            echo "âŒ Repository '$REPO_NAME' is NOT accessible via pacman"
            echo "This will cause build issues!"
            echo "Checking pacman.conf..."
            grep -A 2 "^\[$REPO_NAME\]" /etc/pacman.conf || echo "Repository not in pacman.conf"
          fi
          echo ""
          
          echo "Starting builder script..."
          
          export HOME=/home/builder
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          
          export VPS_USER="$VPS_USER"
          export VPS_HOST="$VPS_HOST"
          export VPS_SSH_KEY="$VPS_SSH_KEY"
          export REPO_SERVER_URL="$REPO_SERVER_URL"
          export REMOTE_DIR="$REMOTE_DIR"
          export REPO_NAME="$REPO_NAME"
          
          su builder -c "cd '$PWD' && python3 builder.py 2>&1" | tee build_output.log
          
          BUILD_STATUS=$?
          echo ""
          echo "=== Build finished with exit code: $BUILD_STATUS ==="
          
          if [ -f "builder.log" ]; then
            echo "=== Last 50 lines of builder.log ==="
            tail -50 builder.log
          fi
          
          exit $BUILD_STATUS

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-results-$(date +%s)
          path: |
            builder.log
            build_output.log
            built_packages/
          retention-days: 7