name: Manjaro Package Builder

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'  # Daily at 4 AM UTC

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Environment
        run: |
          # Initialize pacman
          pacman-key --init
          pacman-key --populate archlinux
          
          # Update system and install ALL required packages via pacman
          pacman -Syu --noconfirm --needed \
            git base-devel sudo \
            python python-pip \
            python-requests python-gitpython python-yaml python-setuptools \
            pacman-contrib \
            curl wget ca-certificates \
            openssh rsync \
            appstream appstream-glib \
            meson ninja cmake \
            gtk-doc docbook-xsl libxslt \
            gobject-introspection \
            autoconf automake libtool pkg-config \
            patch make gcc binutils \
            file which tar gzip bzip2 xz zstd \
            unzip p7zip gnupg \
            dbus polkit \
            systemd systemd-sysvcompat \
            arch-install-scripts
            
          # Create builder user
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # Git safety settings
          git config --system --add safe.directory '*'
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          
          # Set ownership - use absolute path to avoid issues
          chown -R builder:builder "$(pwd)"
          
          # Optimize makepkg
          sed -i '/^OPTIONS=/ s/ debug/ !debug/' /etc/makepkg.conf
          sed -i "s/^COMPRESSZST=.*/COMPRESSZST=(zstd -c -T0 --ultra -20 -)/" /etc/makepkg.conf
          
          echo "✅ Environment preparation complete"

      - name: Setup SSH
        run: |
          mkdir -p /home/builder/.ssh
          
          # Write SSH key (handle both base64 and plain text)
          if echo "${{ secrets.VPS_SSH_KEY }}" | base64 -d >/dev/null 2>&1; then
            echo "${{ secrets.VPS_SSH_KEY }}" | base64 -d > /home/builder/.ssh/id_ed25519
          else
            echo "${{ secrets.VPS_SSH_KEY }}" > /home/builder/.ssh/id_ed25519
          fi
          
          chmod 600 /home/builder/.ssh/id_ed25519
          
          # Add known hosts
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> /home/builder/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H github.com >> /home/builder/.ssh/known_hosts 2>/dev/null || true
          
          chown -R builder:builder /home/builder/.ssh
          echo "✅ SSH setup complete"

      - name: Configure Pacman Repository
        env:
          REPO_SERVER_URL: ${{ secrets.REPO_SERVER_URL }}
          REPO_NAME: ${{ secrets.REPO_NAME || 'manjaro-awesome' }}
        run: |
          echo "=== Configuring Pacman Repository ==="
          echo "Repository: $REPO_NAME"
          echo "Server URL: $REPO_SERVER_URL"
          
          # Backup original pacman.conf
          cp /etc/pacman.conf /etc/pacman.conf.backup
          
          # Check if repository already exists
          if grep -q "\[$REPO_NAME\]" /etc/pacman.conf; then
            echo "⚠️ Repository '$REPO_NAME' already exists in pacman.conf"
            echo "Updating server URL if needed..."
            
            # Update server URL
            sed -i "/\[$REPO_NAME\]/,/^\[/ s|^Server = .*|Server = $REPO_SERVER_URL|" /etc/pacman.conf
          else
            echo "➕ Adding repository '$REPO_NAME' to pacman.conf"
            
            # Create repository configuration
            REPO_CONFIG="\n[$REPO_NAME]\nServer = $REPO_SERVER_URL\nSigLevel = Optional TrustAll\n"
            
            # Find where to insert (before [community] or at end)
            if grep -q "^\[community\]" /etc/pacman.conf; then
              # Insert before [community]
              sed -i "/^\[community\]/i $REPO_CONFIG" /etc/pacman.conf
            elif grep -q "^\[extra\]" /etc/pacman.conf; then
              # Insert after [extra]
              sed -i "/^\[extra\]/a $REPO_CONFIG" /etc/pacman.conf
            else
              # Append at end
              echo -e "$REPO_CONFIG" >> /etc/pacman.conf
            fi
          fi
          
          # Verify the configuration
          echo "=== Pacman.conf repository section ==="
          grep -A 2 "\[$REPO_NAME\]" /etc/pacman.conf || echo "❌ Repository not found in pacman.conf"
          
          # Update pacman database
          echo "Updating pacman database..."
          pacman -Sy --noconfirm
          
          echo "✅ Pacman repository configuration complete"

      - name: Verify Environment
        run: |
          echo "=== Environment Verification ==="
          echo "1. Essential tools:"
          which python && python --version
          which makepkg && makepkg --version | head -1
          which repo-add && echo "✓ repo-add available"
          which ssh && ssh -V
          which git && git --version
          echo ""
          echo "2. Python modules:"
          python -c "import requests; print('✓ requests', requests.__version__)"
          python -c "import git; print('✓ gitpython', git.__version__)"
          python -c "import yaml; print('✓ pyyaml')"
          echo ""
          echo "3. Repository configuration:"
          REPO_NAME="${{ secrets.REPO_NAME || 'manjaro-awesome' }}"
          echo "Looking for repository: $REPO_NAME"
          if grep -q "\[$REPO_NAME\]" /etc/pacman.conf; then
            echo "✅ Repository found in pacman.conf:"
            grep -A 2 "\[$REPO_NAME\]" /etc/pacman.conf
          else
            echo "❌ Repository NOT found in pacman.conf"
            echo "Current pacman.conf repositories:"
            grep "^\[" /etc/pacman.conf
          fi
          echo ""
          echo "✅ Verification complete"

      - name: Run Builder
        env:
          # SSH Connection
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          
          # Repository Configuration
          REPO_SERVER_URL: ${{ secrets.REPO_SERVER_URL }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          REPO_NAME: ${{ secrets.REPO_NAME || 'manjaro-awesome' }}
        run: |
          # Make script executable
          chmod +x builder.py
          
          # Show script info
          echo "=== Builder Script Info ==="
          head -20 builder.py
          echo ""
          
          # Test repository access
          echo "=== Testing repository access ==="
          REPO_NAME="${{ secrets.REPO_NAME || 'manjaro-awesome' }}"
          if pacman -Sl "$REPO_NAME" >/dev/null 2>&1; then
            echo "✅ Repository '$REPO_NAME' is accessible via pacman"
            echo "Available packages in repository:"
            pacman -Sl "$REPO_NAME" | head -20
          else
            echo "❌ Repository '$REPO_NAME' is NOT accessible via pacman"
            echo "This will cause build issues!"
          fi
          echo ""
          
          # Run as builder user
          echo "Starting builder script..."
          
          # Important: Set environment variables for builder
          export HOME=/home/builder
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          
          # Run with output to both console and log file
          su builder -c "cd '$PWD' && python3 builder.py 2>&1" | tee build_output.log
          
          # Check exit status
          BUILD_STATUS=$?
          echo ""
          echo "=== Build finished with exit code: $BUILD_STATUS ==="
          
          # Show log summary
          if [ -f "builder.log" ]; then
            echo "=== Last 50 lines of builder.log ==="
            tail -50 builder.log
          fi
          
          exit $BUILD_STATUS

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-results-$(date +%s)
          path: |
            builder.log
            build_output.log
            built_packages/
          retention-days: 7