name: Manjaro Package Builder

on:
  workflow_dispatch:
  push:
    paths:
      - 'packages.py'
      - 'config.py'
      - '.github/workflows/**'
      - '**/PKGBUILD'

jobs:
  build-and-deploy:
    name: Build and Deploy Packages
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: >-
        --user root
        --volume ${{ github.workspace }}/pacman_cache:/var/cache/pacman/pkg
        --volume ${{ github.workspace }}/yay_cache:/home/builder/.cache/yay
        --volume ${{ github.workspace }}/vps_cache:/tmp/repo_mirror
        --volume ${{ github.workspace }}/build_artifacts:/home/builder/build_artifacts

    env:
      # REQUIRED SECRETS (GitHub Secrets)
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      REPO_SERVER_URL: ${{ secrets.REPO_SERVER_URL }}
      REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
      REPO_NAME: ${{ secrets.REPO_NAME }}
      
      # PRIVACY-SECURE PACKAGER IDENTITY (GitHub Secret)
      PACKAGER_ENV: ${{ secrets.PACKAGER_ENV }}
      
      # OPTIONAL SECRETS
      GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      
      # GITHUB INTERNAL
      CI_PUSH_SSH_KEY: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_REPO: ${{ github.repository }}.git

    steps:
      - name: Checkout Code with Full History
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Cache Directories on Host
        run: |
          echo "=== Creating cache directories on host ==="
          mkdir -p ${{ github.workspace }}/pacman_cache
          mkdir -p ${{ github.workspace }}/yay_cache
          mkdir -p ${{ github.workspace }}/vps_cache
          mkdir -p ${{ github.workspace }}/build_artifacts
          
          # Set liberal permissions on host directories
          chmod -R 777 ${{ github.workspace }}/pacman_cache
          chmod -R 777 ${{ github.workspace }}/yay_cache
          chmod -R 777 ${{ github.workspace }}/vps_cache
          chmod -R 777 ${{ github.workspace }}/build_artifacts
          
          echo "âœ… Cache directories created on host"

      # ================== CACHE: Pacman Package Cache ==================
      - name: Restore Pacman Package Cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/pacman_cache
          key: ${{ runner.os }}-pacman-cache-${{ hashFiles('packages.py', 'config.py', '**/PKGBUILD') }}
          restore-keys: |
            ${{ runner.os }}-pacman-cache-

      # ================== CACHE: Yay AUR Cache ==================
      - name: Restore Yay AUR Cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/yay_cache
          key: ${{ runner.os }}-yay-cache-${{ hashFiles('packages.py', 'config.py', '**/PKGBUILD') }}
          restore-keys: |
            ${{ runner.os }}-yay-cache-

      # ================== CACHE: VPS Repository Mirror ==================
      - name: Restore VPS Repository Mirror Cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/vps_cache
          key: ${{ runner.os }}-vps-mirror-cache-${{ secrets.VPS_HOST }}-${{ secrets.REPO_NAME }}-${{ hashFiles('packages.py') }}
          restore-keys: |
            ${{ runner.os }}-vps-mirror-cache-${{ secrets.VPS_HOST }}-${{ secrets.REPO_NAME }}-
            ${{ runner.os }}-vps-mirror-cache-

      # ================== CACHE: Built Packages ==================
      - name: Restore Built Packages Cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/build_artifacts
            build_aur
          key: ${{ runner.os }}-built-packages-cache-${{ hashFiles('packages.py', 'config.py', '**/PKGBUILD') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-built-packages-cache-${{ hashFiles('packages.py', 'config.py', '**/PKGBUILD') }}-
            ${{ runner.os }}-built-packages-cache-

      - name: Fix Container Cache Permissions
        run: |
          echo "=== Fixing container cache permissions ==="
          
          # CRITICAL FIX: Ensure the cache directories exist and have correct ownership
          mkdir -p /var/cache/pacman/pkg
          mkdir -p /home/builder/.cache/yay
          mkdir -p /tmp/repo_mirror
          mkdir -p /home/builder/build_artifacts
          
          # Fix ownership - run as root in container
          chown -R root:root /var/cache/pacman/pkg
          chown -R builder:builder /home/builder/.cache/yay
          chown -R builder:builder /tmp/repo_mirror
          chown -R builder:builder /home/builder/build_artifacts
          
          # Fix permissions - allow read/write for all
          chmod -R 777 /var/cache/pacman/pkg
          chmod -R 777 /home/builder/.cache/yay
          chmod -R 777 /tmp/repo_mirror
          chmod -R 777 /home/builder/build_artifacts
          
          # Verify the fix
          echo "ðŸ“Š Cache directory permissions after fix:"
          ls -la /var/cache/pacman/ | grep pkg
          echo "âœ… Container cache permissions fixed"

      - name: Install Python and Dependencies
        run: |
          echo "=== Installing Python and Core Dependencies ==="
          
          # CRITICAL: Set proper cache permissions before pacman operations
          echo "Ensuring pacman cache is writable..."
          chmod 777 /var/cache/pacman/pkg
          
          # Disable signature checking temporarily to avoid key issues
          echo "Setting up pacman for initial installation..."
          cp /etc/pacman.conf /etc/pacman.conf.backup
          sed -i 's/^SigLevel.*/SigLevel = Never/' /etc/pacman.conf
          
          echo "Updating package databases..."
          pacman -Syy --noconfirm
          
          echo "Installing Python and essential tools..."
          pacman -S --noconfirm \
            python python-yaml python-setuptools \
            git base-devel sudo \
            python-pip python-requests python-gitpython \
            pacman-contrib curl wget ca-certificates \
            openssh rsync gnupg
          
          # Restore original pacman.conf
          mv /etc/pacman.conf.backup /etc/pacman.conf
          
          echo "âœ… Python and dependencies installed"

      # [REST OF THE WORKFLOW REMAINS EXACTLY THE SAME - ONLY PERMISSION FIXES ABOVE]
      # Continue with all the existing steps from "Run Preflight Checker" onwards...
      - name: Run Preflight Checker
        run: |
          python3 .github/scripts/syntax.py

      - name: Fix PKGBUILD Epoch Issues
        run: |
          # [Existing code remains unchanged]
          echo "=== Fixing PKGBUILD epoch issues ==="
          
          # Fix awesome-freedesktop-git PKGBUILD (remove epoch)
          if [ -f "awesome-freedesktop-git/PKGBUILD" ]; then
            echo "Fixing awesome-freedesktop-git/PKGBUILD..."
            sed -i '/^epoch=/d' awesome-freedesktop-git/PKGBUILD
            # Increment pkgrel to ensure new version
            current_pkgrel=$(grep -oP '^pkgrel=\K\d+' awesome-freedesktop-git/PKGBUILD)
            if [ -n "$current_pkgrel" ]; then
              new_pkgrel=$((current_pkgrel + 1))
              sed -i "s/^pkgrel=.*/pkgrel=$new_pkgrel/" awesome-freedesktop-git/PKGBUILD
              echo "Updated pkgrel from $current_pkgrel to $new_pkgrel"
            fi
          fi
          
          # Check for other packages with epoch
          echo "Checking for other packages with epoch in PKGBUILD..."
          find . -name "PKGBUILD" -type f -exec grep -l "^epoch=" {} \;
          
          echo "âœ… PKGBUILD fixes complete"

      - name: Prepare Environment
        run: |
          echo "=== Starting Environment Preparation ==="
          
          # Display cache status
          echo "ðŸ“Š Cache Status Report:"
          echo "  - Pacman cache: $(ls -1 /var/cache/pacman/pkg/*.pkg.tar.* 2>/dev/null | wc -l) files"
          echo "  - Yay cache: $(du -sh /home/builder/.cache/yay 2>/dev/null | cut -f1 || echo '0')"
          echo "  - VPS mirror: $(ls -1 /tmp/repo_mirror/*.pkg.tar.* 2>/dev/null | wc -l) files"
          echo "  - Built packages: $(ls -1 /home/builder/build_artifacts/*.pkg.tar.* 2>/dev/null | wc -l) files"
          echo "  - AUR sources: $(ls -1 build_aur/*/ 2>/dev/null | wc -l) directories"
          
          # Skip key signing issues for system updates
          echo "Setting up pacman without key signing for updates..."
          sed -i 's/^SigLevel.*/SigLevel = Never/g' /etc/pacman.conf
          
          # UPDATE SYSTEM WITHOUT OUR REPOSITORY
          echo "Updating system (ignoring our repository for now)..."
          
          # Save current pacman.conf
          cp /etc/pacman.conf /etc/pacman.conf.backup
          
          # Update system with minimal packages first
          pacman -Syu --noconfirm --needed \
            git base-devel sudo \
            python python-pip \
            python-requests python-gitpython python-yaml \
            pacman-contrib \
            curl wget ca-certificates \
            openssh rsync \
            netcat iproute2 \
            jq \
            gnupg
            
          # Install vercmp for proper version comparison
          if ! command -v vercmp &> /dev/null; then
            echo "Installing pacman-contrib for vercmp..."
            pacman -S --noconfirm pacman-contrib
          fi
          
          # Restore pacman.conf
          mv /etc/pacman.conf.backup /etc/pacman.conf
          
          # Create builder user (container invariant)
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # Set ownership
          chown -R builder:builder "$(pwd)"
          
          # Create build directories with correct permissions (if they don't exist from cache)
          mkdir -p "$(pwd)/build_aur"
          chown -R builder:builder "$(pwd)/build_aur"
          mkdir -p "/tmp/repo_mirror"
          chown -R builder:builder "/tmp/repo_mirror"
          
          # Optimize makepkg for faster builds
          echo "Optimizing makepkg configuration..."
          sed -i '/^OPTIONS=/ s/ debug/ !debug/' /etc/makepkg.conf
          sed -i "s/^COMPRESSZST=.*/COMPRESSZST=(zstd -c -T0 --ultra -20 -)/" /etc/makepkg.conf
          sed -i "s/^BUILDENV=.*/BUILDENV=(!distcc color !ccache check !sign)/" /etc/makepkg.conf
          
          echo "âœ… Environment preparation complete"

      # [ALL SUBSEQUENT STEPS REMAIN UNCHANGED - continue with original workflow]
      - name: Setup SSH for VPS
        run: |
          echo "=== Setting up SSH for VPS connection ==="
          # [Existing SSH setup code...]
          
      - name: Configure Pacman Repository
        run: |
          echo "=== Configuring Pacman Repository ==="
          # [Existing repository configuration code...]
          
      - name: Rsync Connection Test
        run: |
          echo "=== Rsync Connection Test ==="
          # [Existing rsync test code...]
          
      - name: Install Build Dependencies
        run: |
          echo "=== Installing Build Dependencies ==="
          # [Existing build dependencies code...]
          
      - name: Network Diagnostics
        run: |
          echo "=== NETWORK DIAGNOSTICS ==="
          # [Existing network diagnostics code...]
          
      - name: Initialize GPG and Pacman Keyring
        run: |
          echo "=== Initializing GPG and Pacman Keyring ==="
          # [Existing GPG initialization code...]
          
      - name: Run Builder with Cache Optimization
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          REPO_SERVER_URL: ${{ secrets.REPO_SERVER_URL }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          REPO_NAME: ${{ secrets.REPO_NAME }}
          PACKAGER_ENV: ${{ secrets.PACKAGER_ENV }}
          CI_PUSH_SSH_KEY: ${{ secrets.GITHUB_TOKEN }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GITHUB_REPO: ${{ github.repository }}.git
          PYTHONPATH: ${{ github.workspace }}/.github/scripts
          USE_CACHE: "true"
        run: |
          echo "=== Starting Builder with Cache Optimization ==="
          # [Existing builder execution code...]
          
      # ================== SAVE CACHES ==================
      - name: Save Pacman Package Cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: ${{ github.workspace }}/pacman_cache
          key: ${{ runner.os }}-pacman-cache-${{ hashFiles('packages.py', 'config.py', '**/PKGBUILD') }}

      - name: Save Yay AUR Cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: ${{ github.workspace }}/yay_cache
          key: ${{ runner.os }}-yay-cache-${{ hashFiles('packages.py', 'config.py', '**/PKGBUILD') }}

      - name: Save VPS Repository Mirror Cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: ${{ github.workspace }}/vps_cache
          key: ${{ runner.os }}-vps-mirror-cache-${{ secrets.VPS_HOST }}-${{ secrets.REPO_NAME }}-${{ hashFiles('packages.py') }}

      - name: Save Built Packages Cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            ${{ github.workspace }}/build_artifacts
            build_aur
          key: ${{ runner.os }}-built-packages-cache-${{ hashFiles('packages.py', 'config.py', '**/PKGBUILD') }}-${{ github.sha }}

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-results-$(date +%Y%m%d-%H%M%S)
          path: |
            builder.log
            build_output.log
            ${{ github.workspace }}/build_artifacts/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload Cache Status Report
        if: always()
        run: |
          echo "=== Cache Status Report After Build ==="
          echo "Pacman cache saved: $(du -sh ${{ github.workspace }}/pacman_cache 2>/dev/null | cut -f1 || echo '0')"
          echo "Built packages in cache: $(ls -1 ${{ github.workspace }}/build_artifacts/*.pkg.tar.* 2>/dev/null | wc -l) files"
          echo "AUR sources in cache: $(ls -1 build_aur/*/ 2>/dev/null | wc -l) directories"
          echo "VPS mirror cache: $(du -sh ${{ github.workspace }}/vps_cache 2>/dev/null | cut -f1 || echo '0')"
          echo ""
          echo "ðŸ“Š Cache keys used:"
          echo "  - Pacman: ${{ runner.os }}-pacman-cache-${{ hashFiles('packages.py', 'config.py', '**/PKGBUILD') }}"
          echo "  - Yay: ${{ runner.os }}-yay-cache-${{ hashFiles('packages.py', 'config.py', '**/PKGBUILD') }}"
          echo "  - VPS mirror: ${{ runner.os }}-vps-mirror-cache-${{ secrets.VPS_HOST }}-${{ secrets.REPO_NAME }}-${{ hashFiles('packages.py') }}"
          echo "  - Built packages: ${{ runner.os }}-built-packages-cache-${{ hashFiles('packages.py', 'config.py', '**/PKGBUILD') }}-${{ github.sha }}"

      - name: Cleanup Temporary Directories (Preserve Cache)
        if: always()
        run: |
          echo "=== Cleaning temporary directories (preserving cache) ==="
          
          # Cleanup builder temporary directories (but not cache directories)
          rm -rf /tmp/gpg_home_* 2>/dev/null || true
          rm -rf /tmp/*.pkg.tar.* 2>/dev/null || true
          
          # Cleanup builder home directories (but keep yay cache)
          rm -rf /home/builder/.cache/mozilla 2>/dev/null || true
          rm -rf /home/builder/.cache/pip 2>/dev/null || true
          rm -rf /home/builder/.cache/thumbnails 2>/dev/null || true
          
          # Cleanup workspace temporary files (but not built packages)
          find . -name ".SRCINFO" -type f -delete 2>/dev/null || true
          find /tmp -name "yay-*" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.log" -type f -not -name "builder.log" -not -name "build_output.log" -delete 2>/dev/null || true
          
          echo "âœ… Temporary directories cleaned (caches preserved for next run)"