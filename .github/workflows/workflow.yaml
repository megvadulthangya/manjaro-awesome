name: Manjaro Package Builder

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'  # Daily at 4 AM UTC

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      # ELT√ÅVOL√çTVA: --network host (mert √ºtk√∂zik a GitHub Actions h√°l√≥zat√°val)
      # Helyette explicit h√°l√≥zati be√°ll√≠t√°sok a kont√©neren bel√ºl

    env:
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      REPO_SERVER_URL: ${{ secrets.REPO_SERVER_URL }}
      REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
      REPO_NAME: ${{ secrets.REPO_NAME || 'manjaro-awesome' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Environment
        run: |
          echo "=== Starting Environment Preparation ==="
          echo "Repository: $REPO_NAME"
          echo "Server URL: $REPO_SERVER_URL"
          
          # Network debugging
          echo "=== Network Configuration ==="
          echo "Hostname: $(hostname)"
          echo "IP addresses:"
          ip addr show || ifconfig || echo "Network tools not available"
          echo ""
          
          # Install netcat for network testing
          pacman -Syu --noconfirm --needed netcat
          
          # Initialize pacman
          pacman-key --init
          pacman-key --populate archlinux
          
          # Update system and install ALL required packages via pacman
          pacman -Syu --noconfirm --needed \
            git base-devel sudo \
            python python-pip \
            python-requests python-gitpython python-yaml python-setuptools \
            pacman-contrib \
            curl wget ca-certificates \
            openssh rsync \
            appstream appstream-glib \
            meson ninja cmake \
            gtk-doc docbook-xsl libxslt \
            gobject-introspection \
            autoconf automake libtool pkg-config \
            patch make gcc binutils \
            file which tar gzip bzip2 xz zstd \
            unzip p7zip gnupg \
            dbus polkit \
            systemd systemd-sysvcompat \
            arch-install-scripts
            
          # Create builder user
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # Git safety settings
          git config --system --add safe.directory '*'
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          
          # Set ownership - use absolute path to avoid issues
          chown -R builder:builder "$(pwd)"
          
          # Optimize makepkg
          sed -i '/^OPTIONS=/ s/ debug/ !debug/' /etc/makepkg.conf
          sed -i "s/^COMPRESSZST=.*/COMPRESSZST=(zstd -c -T0 --ultra -20 -)/" /etc/makepkg.conf
          
          echo "‚úÖ Environment preparation complete"

      - name: Setup SSH
        run: |
          echo "=== Current environment variables ==="
          env | grep -E "VPS|REPO|REMOTE" || echo "No VPS/REPO env vars found"
          echo ""
          
          mkdir -p /home/builder/.ssh
          chmod 700 /home/builder/.ssh
          
          echo "=== Checking SSH key ==="
          if [ -z "$VPS_SSH_KEY" ]; then
            echo "‚ùå ERROR: VPS_SSH_KEY is empty!"
            exit 1
          else
            echo "‚úÖ SSH key is set (length: ${#VPS_SSH_KEY} chars)"
          fi
          
          echo "=== Writing SSH key ==="
          if echo "$VPS_SSH_KEY" | base64 -d >/dev/null 2>&1; then
            echo "üîë Key appears to be base64 encoded, decoding..."
            echo "$VPS_SSH_KEY" | base64 -d > /home/builder/.ssh/id_ed25519
            echo "‚úÖ Key decoded from base64"
          else
            echo "üîë Key is plain text, writing as-is..."
            echo "$VPS_SSH_KEY" > /home/builder/.ssh/id_ed25519
            echo "‚úÖ Key written as plain text"
          fi
          
          chmod 600 /home/builder/.ssh/id_ed25519
          
          echo "Creating SSH config..."
          echo "Host $VPS_HOST" > /home/builder/.ssh/config
          echo "  HostName $VPS_HOST" >> /home/builder/.ssh/config
          echo "  User $VPS_USER" >> /home/builder/.ssh/config
          echo "  IdentityFile ~/.ssh/id_ed25519" >> /home/builder/.ssh/config
          echo "  Port 22" >> /home/builder/.ssh/config
          echo "  ConnectTimeout 30" >> /home/builder/.ssh/config
          echo "  ServerAliveInterval 60" >> /home/builder/.ssh/config
          echo "  ServerAliveCountMax 3" >> /home/builder/.ssh/config
          echo "  TCPKeepAlive yes" >> /home/builder/.ssh/config
          echo "  ControlMaster auto" >> /home/builder/.ssh/config
          echo "  ControlPath ~/.ssh/control-%r@%h:%p" >> /home/builder/.ssh/config
          echo "  ControlPersist 10m" >> /home/builder/.ssh/config
          
          chmod 600 /home/builder/.ssh/config
          
          echo "=== Adding known hosts ==="
          if [ -n "$VPS_HOST" ]; then
            echo "Adding $VPS_HOST..."
            ssh-keyscan -H "$VPS_HOST" > /home/builder/.ssh/known_hosts 2>/dev/null
            if [ $? -eq 0 ]; then
              echo "‚úÖ SSH key for $VPS_HOST added to known_hosts"
            else
              echo "‚ö†Ô∏è Failed to get key for $VPS_HOST, trying with -t rsa,ecdsa,ed25519..."
              ssh-keyscan -t rsa,ecdsa,ed25519 -H "$VPS_HOST" >> /home/builder/.ssh/known_hosts 2>/dev/null
            fi
          else
            echo "‚ö†Ô∏è VPS_HOST is empty!"
          fi
          
          echo "Adding github.com..."
          ssh-keyscan -H github.com >> /home/builder/.ssh/known_hosts 2>/dev/null
          
          chown -R builder:builder /home/builder/.ssh
          
          echo "‚úÖ SSH setup complete"

      - name: Configure Pacman Repository
        run: |
          echo "=== Configuring Pacman Repository ==="
          echo "Repository: $REPO_NAME"
          echo "Server URL: $REPO_SERVER_URL"
          echo ""
          
          if [ -z "$REPO_NAME" ] || [ -z "$REPO_SERVER_URL" ]; then
            echo "‚ùå ERROR: REPO_NAME or REPO_SERVER_URL is empty!"
            exit 1
          fi
          
          cp /etc/pacman.conf /etc/pacman.conf.backup
          
          if grep -q "^\[$REPO_NAME\]" /etc/pacman.conf; then
            echo "‚ö†Ô∏è Repository '$REPO_NAME' already exists in pacman.conf"
            echo "Updating server URL if needed..."
            
            sed -i "/\[$REPO_NAME\]/,/^\[/ s|^Server = .*|Server = $REPO_SERVER_URL|" /etc/pacman.conf
          else
            echo "‚ûï Adding repository '$REPO_NAME' to pacman.conf"
            
            echo "Creating repository configuration..."
            
            TEMP_FILE=$(mktemp)
            echo "[$REPO_NAME]" > "$TEMP_FILE"
            echo "Server = $REPO_SERVER_URL" >> "$TEMP_FILE"
            echo "SigLevel = Optional TrustAll" >> "$TEMP_FILE"
            
            if grep -q "^\[community\]" /etc/pacman.conf; then
              echo "Inserting before [community] section..."
              LINE_NUM=$(grep -n "^\[community\]" /etc/pacman.conf | cut -d: -f1)
              head -n $((LINE_NUM-1)) /etc/pacman.conf > /etc/pacman.conf.tmp
              cat "$TEMP_FILE" >> /etc/pacman.conf.tmp
              tail -n +$LINE_NUM /etc/pacman.conf >> /etc/pacman.conf.tmp
              mv /etc/pacman.conf.tmp /etc/pacman.conf
            else
              echo "Appending at end of file..."
              cat "$TEMP_FILE" >> /etc/pacman.conf
            fi
            
            rm -f "$TEMP_FILE"
          fi
          
          echo "=== Pacman.conf repository section ==="
          grep -A 2 "^\[$REPO_NAME\]" /etc/pacman.conf || echo "‚ùå Repository not found in pacman.conf"
          
          echo ""
          echo "=== Context around repository in pacman.conf ==="
          grep -n -B 2 -A 2 "^\[$REPO_NAME\]" /etc/pacman.conf || echo "No context found"
          
          echo ""
          echo "Updating pacman database..."
          if pacman -Sy --noconfirm; then
            echo "‚úÖ Pacman database synchronized"
            
            echo ""
            echo "=== Testing repository access ==="
            if pacman -Sl "$REPO_NAME" >/dev/null 2>&1; then
              echo "‚úÖ Repository '$REPO_NAME' is accessible via pacman"
              echo "Available packages in repository:"
              pacman -Sl "$REPO_NAME" | head -10
            else
              echo "‚ö†Ô∏è Repository '$REPO_NAME' found but not accessible via pacman"
            fi
          else
            echo "‚ùå Failed to sync pacman database"
            echo "Check /etc/pacman.conf for syntax errors"
            echo "Last 10 lines of pacman.conf:"
            tail -10 /etc/pacman.conf
          fi
          
          echo "‚úÖ Pacman repository configuration complete"

      - name: Verify Network Connectivity
        run: |
          echo "=== Network Connectivity Tests ==="
          
          echo "=== Container Network Info ==="
          echo "Hostname: $(hostname)"
          ip addr show 2>/dev/null || echo "ip command not available"
          echo ""
          
          echo "=== DNS Resolution Test ==="
          echo "Testing DNS resolution..."
          nslookup google.com 2>/dev/null || dig google.com 2>/dev/null || echo "DNS tools not available"
          echo ""
          
          echo "=== Route Test ==="
          ip route show 2>/dev/null || route -n 2>/dev/null || echo "Route tools not available"
          echo ""
          
          echo "1. Testing internet connectivity..."
          if ping -c 2 8.8.8.8 >/dev/null 2>&1; then
            echo "‚úÖ Internet connectivity OK (via IP)"
          else
            echo "‚ùå No internet connectivity via IP"
          fi
          
          echo "Testing internet via domain..."
          if ping -c 2 google.com >/dev/null 2>&1; then
            echo "‚úÖ Internet connectivity OK (via domain)"
          else
            echo "‚ùå No internet connectivity via domain"
          fi
          
          echo ""
          echo "2. Testing SSH connectivity to $VPS_HOST..."
          if [ -n "$VPS_HOST" ] && [ -n "$VPS_USER" ]; then
            echo "Testing connection to $VPS_USER@$VPS_HOST..."
            
            echo "Resolving $VPS_HOST..."
            if getent hosts "$VPS_HOST" >/dev/null 2>&1; then
              echo "‚úÖ Hostname resolves: $(getent hosts $VPS_HOST)"
            else
              echo "‚ùå Cannot resolve hostname $VPS_HOST"
              echo "Trying alternative DNS resolution..."
              nslookup "$VPS_HOST" 2>/dev/null || dig "$VPS_HOST" 2>/dev/null || echo "Alternative DNS tools not available"
            fi
            
            # Test TCP connectivity first
            echo "Testing TCP connectivity to $VPS_HOST:22..."
            if timeout 5 nc -z -w 2 "$VPS_HOST" 22; then
              echo "‚úÖ TCP port 22 is accessible on $VPS_HOST"
            else
              echo "‚ùå Cannot reach $VPS_HOST on port 22"
              echo "Trying with telnet..."
              timeout 5 bash -c "echo > /dev/tcp/$VPS_HOST/22" 2>/dev/null && echo "‚úÖ TCP connection successful via bash" || echo "‚ùå TCP connection failed"
            fi
            
            echo "Attempting SSH connection..."
            if timeout 15 ssh -o ConnectTimeout=10 -o BatchMode=yes -v "$VPS_USER@$VPS_HOST" "echo SSH_TEST_OK" 2>&1 | grep -q "SSH_TEST_OK"; then
              echo "‚úÖ SSH connection successful"
            else
              echo "‚ùå SSH connection failed"
              echo "Debug info:"
              echo "  VPS_HOST: $VPS_HOST"
              echo "  VPS_USER: $VPS_USER"
              
              # Try with more detailed error
              echo "=== Detailed SSH debug ==="
              timeout 10 ssh -vvv -o ConnectTimeout=5 "$VPS_USER@$VPS_HOST" "echo test" 2>&1 | tail -20
            fi
          else
            echo "‚ö†Ô∏è VPS_HOST or VPS_USER not set"
          fi
          
          echo ""
          echo "3. Testing repository server $REPO_SERVER_URL..."
          if [ -n "$REPO_SERVER_URL" ]; then
            REPO_HOST=$(echo "$REPO_SERVER_URL" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
            echo "Testing connection to $REPO_HOST..."
            if timeout 5 curl -I "$REPO_SERVER_URL" >/dev/null 2>&1; then
              echo "‚úÖ Repository server reachable"
            else
              echo "‚ùå Repository server not reachable"
              echo "Trying with wget..."
              timeout 5 wget --spider "$REPO_SERVER_URL" 2>/dev/null && echo "‚úÖ Repository server reachable via wget" || echo "‚ùå Repository server not reachable via wget"
            fi
          fi
          
          echo "‚úÖ Network tests complete"

      - name: Run Builder
        run: |
          chmod +x builder.py
          
          echo "=== Current Environment in Builder Step ==="
          echo "PWD: $(pwd)"
          echo "VPS_USER: $VPS_USER"
          echo "VPS_HOST: $VPS_HOST"
          echo "REPO_NAME: $REPO_NAME"
          echo "REPO_SERVER_URL: $REPO_SERVER_URL"
          echo "REMOTE_DIR: $REMOTE_DIR"
          echo ""
          
          echo "=== SSH Configuration ==="
          ls -la /home/builder/.ssh/
          echo "SSH config:"
          cat /home/builder/.ssh/config 2>/dev/null || echo "No SSH config"
          echo ""
          
          echo "=== Pre-build SSH Test ==="
          echo "Testing SSH connection (timeout 15s)..."
          if timeout 15 ssh -o ConnectTimeout=10 -o BatchMode=yes "$VPS_USER@$VPS_HOST" "echo PRE_BUILD_SSH_TEST_OK && hostname" 2>/dev/null; then
            echo "‚úÖ SSH test successful"
          else
            echo "‚ùå SSH test failed"
            echo "This will cause build failures!"
            echo "Will continue anyway to see if packages can be built..."
          fi
          echo ""
          
          echo "=== Builder Script Info ==="
          head -20 builder.py
          echo ""
          
          echo "=== Testing repository access ==="
          if pacman -Sl "$REPO_NAME" >/dev/null 2>&1; then
            echo "‚úÖ Repository '$REPO_NAME' is accessible via pacman"
            echo "Available packages in repository:"
            pacman -Sl "$REPO_NAME" | head -20
          else
            echo "‚ùå Repository '$REPO_NAME' is NOT accessible via pacman"
            echo "This will cause build issues!"
            echo "Checking pacman.conf..."
            grep -A 2 "^\[$REPO_NAME\]" /etc/pacman.conf || echo "Repository not in pacman.conf"
          fi
          echo ""
          
          echo "Starting builder script..."
          
          export HOME=/home/builder
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          
          export VPS_USER="$VPS_USER"
          export VPS_HOST="$VPS_HOST"
          export VPS_SSH_KEY="$VPS_SSH_KEY"
          export REPO_SERVER_URL="$REPO_SERVER_URL"
          export REMOTE_DIR="$REMOTE_DIR"
          export REPO_NAME="$REPO_NAME"
          
          # Run builder with proper error handling
          set +e
          su builder -c "cd '$PWD' && python3 builder.py 2>&1" | tee build_output.log
          BUILD_STATUS=$?
          set -e
          
          echo ""
          echo "=== Build finished with exit code: $BUILD_STATUS ==="
          
          if [ -f "builder.log" ]; then
            echo "=== Last 50 lines of builder.log ==="
            tail -50 builder.log
          fi
          
          # Even if SSH failed, we might have built packages
          echo "=== Checking for built packages ==="
          if [ -d "built_packages" ] && [ "$(ls -A built_packages 2>/dev/null)" ]; then
            echo "‚úÖ Packages were built:"
            ls -la built_packages/
          else
            echo "‚ùå No packages were built"
          fi
          
          exit $BUILD_STATUS

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-results-$(date +%s)
          path: |
            builder.log
            build_output.log
            built_packages/
          retention-days: 7