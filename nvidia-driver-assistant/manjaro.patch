--- nvidia-driver-assistant.orig    2024-11-26 09:02:18.000000000 +0700
+++ nvidia-driver-assistant 2025-12-31 10:00:00.000000000 +0100
@@ -30,6 +30,7 @@
 import os
 import json
 import argparse
+import platform
 import string
 import sys
 
@@ -91,6 +92,10 @@
     "rhel-open": ["sudo dnf -y module install nvidia-driver:open-dkms"],
     "ubuntu-closed": ["sudo apt-get install -y cuda-drivers"],
     "ubuntu-open": ["sudo apt-get install -y nvidia-open"],
+    "arch-closed": ["sudo pacman -S nvidia-dkms"],
+    "arch-open": ["sudo pacman -S nvidia-open-dkms"],
+    "manjaro-closed": ["sudo pacman -S KERNEL-nvidia"],
+    "manjaro-open": ["sudo pacman -S KERNEL-nvidia-open"],
 }
 
 branch_instructions = {
@@ -112,6 +117,10 @@
     "rhel-open": ["sudo dnf -y module install nvidia-driver:BRANCH-open"],
     "ubuntu-closed": ["sudo apt-get install -y cuda-drivers-BRANCH"],
     "ubuntu-open": ["sudo apt-get install -y nvidia-open-BRANCH"],
+    "arch-closed": ["Not supported"],
+    "arch-open": ["Not supported"],
+    "manjaro-closed": ["sudo pacman -S KERNEL-nvidia-BRANCHxx"],
+    "manjaro-open": ["Not supported"],
 }
 
 proprietary_required = "proprietary_required"
 
+def get_architecture_from_chip_family(chip_family):
+    if not chip_family:
+        return "unknown"
+    chip_family = chip_family.upper()
+    if chip_family.startswith("GM"):
+        return "maxwell"
+    if chip_family.startswith("GP"):
+        return "pascal"
+    if chip_family.startswith("GV"):
+        return "volta"
+    if chip_family.startswith("TU"):
+        return "turing"
+    if chip_family.startswith("GA"):
+        return "ampere"
+    if chip_family.startswith("AD"):
+        return "ada"
+    if chip_family.startswith("GH"):
+        return "hopper"
+    return "unknown"
+
 
 class Device(object):
     def __init__(self, dev_id, name, features, legacybranch=None, chip_family=None, driver_hint=None):
@@ -124,6 +147,14 @@
         self.features = features
         self.legacy_branch = legacybranch
         self.driver_hint = driver_hint
+        self.chip_family = chip_family
+        self.architecture = get_architecture_from_chip_family(chip_family)
+
+        logging.debug(
+            "Device detected: %s (arch=%s, chip_family=%s, driver_hint=%s, legacy_branch=%s)"
+            % (self.name, self.architecture, chip_family, self.driver_hint, self.legacy_branch)
+        )
 
         if not self.driver_hint:
             if self.legacy_branch:
@@ -133,6 +164,17 @@
             try:
                 if int(self.legacy_branch.split(".")[0]) <= 470:
                     self.driver_hint = proprietary_required
+            except ValueError:
+                pass
+
+        # Enforce proprietary driver for unsupported open-kernel architectures
+        # NVIDIA Open Kernel Module supports only Turing and newer
+        if self.driver_hint == "open" and self.architecture in ("maxwell", "pascal", "volta"):
+            logging.debug(
+                "Forcing proprietary driver for %s (%s architecture)"
+                % (self.name, self.architecture)
+            )
+            self.driver_hint = "proprietary"
+
+
+def manjaro_get_kernel_package():
+    rel = platform.release()
+    parts = rel.split(".")
+    if len(parts) >= 2 and parts[0].isdigit() and parts[1].isdigit():
+        return f"linux{parts[0]}{parts[1]}"
+    logging.warning("Unexpected kernel release format: %s", rel)
+    return None
+
+
+def manjaro_get_legacy_branch(devices):
+    for dev in devices.values():
+        if dev.legacy_branch:
+            return dev.legacy_branch.split(".")[0]
+    return None
 
 
 def get_driver_from_json_hints(devices):
@@ -386,6 +428,18 @@
     proprietary_required = "proprietary_required"
     for dev in devices.values():
+        # Architecture-based override for open kernel module
+        if dev.driver_hint == "open" and dev.architecture in ("maxwell", "pascal", "volta"):
+            logging.debug(
+                "JSON hint override: %s (%s) does not support open kernel module"
+                % (dev.name, dev.architecture)
+            )
+            if dev.legacy_branch:
+                hints.append(proprietary_required)
+            else:
+                hints.append("proprietary")
+            continue
+
         if dev.driver_hint:
             hints.append(dev.driver_hint)
 
@@ -427,7 +481,7 @@
 
 
-def recommend_driver(sys_path=None, supported_gpus=None, use_driver_hints=False):
+def recommend_driver(sys_path=None, supported_gpus=None, use_driver_hints=False):
     devices = get_nvidia_devices(sys_path, supported_gpus)
     print_pretty_gpu_summary(devices)
 
@@ -438,9 +492,9 @@
     if use_driver_hints:
         logging.debug("recommend_driver(): using json logic")
-        return get_driver_from_json_hints(devices)
+        return get_driver_from_json_hints(devices), devices
     else:
         logging.debug("recommend_driver(): using VDPAU logic")
-        return get_driver_from_vdpau_feat(devices)
+        return get_driver_from_vdpau_feat(devices), devices
 
 
 def process_results(driver, distro_id, version_id, branch_id):
@@ -467,6 +521,14 @@
             print("Error: failed to get the latest driver branch", file=sys.stderr)
             return False
 
+    if distro_id == "manjaro":
+        kernel_id = manjaro_get_kernel_package()
+        if kernel_id:
+            for i, line in enumerate(candidates):
+                candidates[i] = line.replace("KERNEL", kernel_id)
+
     if branch_id:
         for i, line in enumerate(candidates):
             candidates[i] = line.replace("BRANCH", branch_id)
@@ -598,7 +660,7 @@
     if args.verbose:
         logging.getLogger().setLevel(logging.DEBUG)
 
-    driver = recommend_driver(
+    driver, devices = recommend_driver(
         sys_path=sys_path, supported_gpus=supported_gpus, use_driver_hints=True
     )
     if not driver:
@@ -623,6 +685,10 @@
     logging.debug("OS detected: %s", system_info.id)
 
+    if not branch_locked and system_info.id == "manjaro":
+        branch_locked = manjaro_get_legacy_branch(devices)
+
     if needs_install:
         install_driver(driver, system_info.id, system_info.version_id, branch_locked)
