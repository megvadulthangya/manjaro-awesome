# Maintainer: Philip MÃ¼ller <philm[at]manjaro[dot]org>
# Patched for Manjaro ISO build (local source, no download)

pkgname=nvidia-driver-assistant
pkgver=0.23.48.02
pkgrel=1

pkgdesc="Detect and install the best NVIDIA driver packages for the system (Manjaro patched)"
arch=('any')
url="https://www.nvidia.com/"
license=('MIT AND LicenseRef-custom')
depends=('python')

# --- IMPORTANT ---
# Manjaro ISO build tooling MUST NOT try to download sources
source=(
  "nvidia-driver-assistant_0.23.48.01-1_all.deb::local"
  "manjaro.patch"
  "show-driver"
)

noextract=(
  "nvidia-driver-assistant_0.23.48.01-1_all.deb"
)

sha256sums=(
  '63b7eb75805530914f723213af8ec6070089d60782bece179dd6fc22caf914a9'
  'efd0b696193e006d8eeebcea6812248258f7211eedc8b143927a38abbad04c9c'
  'ba2de9ef5a7295b3127bef360a5da89cacaec7c7362e351b33177045bcf9e3f7'
)

prepare() {
  mkdir -p "${pkgname}-${pkgver}"
  cd "${pkgname}-${pkgver}"

  # Extract local .deb directly (CI + ISO safe)
  bsdtar -xf "${srcdir}/nvidia-driver-assistant_0.23.48.01-1_all.deb"

  # Apply Manjaro patch
  patch -Np1 -i "${srcdir}/manjaro.patch"
}

package() {
  cd "${pkgname}-${pkgver}"

  install -Dm755 usr/bin/${pkgname} \
    "${pkgdir}/usr/bin/${pkgname}"

  install -Dm644 usr/share/${pkgname}/supported-gpus/*.json \
    "${pkgdir}/usr/share/${pkgname}/supported-gpus/"

  install -Dm644 usr/share/doc/${pkgname}/README.md \
    "${pkgdir}/usr/share/doc/${pkgname}/README.md"

  install -Dm644 usr/share/doc/${pkgname}/CONTRIBUTING.md \
    "${pkgdir}/usr/share/doc/${pkgname}/CONTRIBUTING.md"

  install -Dm644 usr/share/doc/${pkgname}/copyright \
    "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"

  install -Dm644 usr/share/${pkgname}/driver_eula/LICENSE \
    "${pkgdir}/usr/share/${pkgname}/driver_eula/LICENSE"

  ln -sf /usr/share/${pkgname}/driver_eula/LICENSE \
    "${pkgdir}/usr/share/licenses/${pkgname}/EULA"

  install -Dm755 "${srcdir}/show-driver" \
    "${pkgdir}/usr/bin/nvidia-recommended-driver"
}
