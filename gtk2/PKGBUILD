# Maintainer: Jan Alexander Steffens (heftig) <heftig@archlinux.org>
# Maintainer: Jan de Groot <jgc@archlinux.org>
# Modified for GitHub Actions - auto-downloads everything Gyöngyösi Gábor 

pkgname=gtk2
pkgver=2.24.33
pkgrel=5
pkgdesc="GObject-based multi-platform GUI toolkit (legacy)"
arch=(x86_64)
license=(LGPL-2.1-or-later)
depends=(
  atk
  cairo
  desktop-file-utils
  fontconfig
  gdk-pixbuf2
  glib2
  glibc
  gtk-update-icon-cache
  libcups
  librsvg
  libx11
  libxcomposite
  libxcursor
  libxdamage
  libxext
  libxfixes
  libxi
  libxinerama
  libxrandr
  libxrender
  pango
  shared-mime-info
)
makedepends=(
  glib2-devel
  gobject-introspection
  gtk-doc
)

# AUTO-DOWNLOAD EVERYTHING from official Arch sources
source=(
  # 1. GTK source from GitHub mirror
  "https://github.com/GNOME/gtk/archive/refs/tags/${pkgver}.tar.gz"
  
  # 2. Hook file from Arch Linux official packaging repo
  "https://gitlab.archlinux.org/archlinux/packaging/packages/gtk2/-/raw/main/gtk-query-immodules-2.0.hook"
  
  # 3. Patch files from Arch Linux official packaging repo
  "https://gitlab.archlinux.org/archlinux/packaging/packages/gtk2/-/raw/main/0001-Lower-severity-of-XID-collision-warnings.patch"
  "https://gitlab.archlinux.org/archlinux/packaging/packages/gtk2/-/raw/main/0002-Stop-looking-for-modules-in-cwd.patch"
)

# Checksums - SKIP for hook and patches as they come from trusted Arch sources
sha256sums=('dedfaf04952434c5e3e1ce4de373ac7474d12da2d99b0afc947ef1983df64601'
            'SKIP'
            'SKIP'
            'SKIP')

prepare() {
  cd "gtk-${pkgver}"
  
  # Apply patches downloaded from Arch Linux
  patch -Np1 -i ../0001-Lower-severity-of-XID-collision-warnings.patch
  patch -Np1 -i ../0002-Stop-looking-for-modules-in-cwd.patch
  
  # Fix for automake
  sed -i '/AM_INIT_AUTOMAKE/s/]/ foreign]/' configure.ac
  autoreconf -fvi
}

build() {
  local configure_options=(
    --prefix=/usr
    --sysconfdir=/etc
    --localstatedir=/var
    --with-xinput=yes
    --disable-gtk-doc
  )

  CFLAGS+=" -Wno-error=implicit-int -Wno-error=incompatible-pointer-types"

  cd "gtk-${pkgver}"
  ./configure "${configure_options[@]}"
  sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool
  make
}

package() {
  optdepends=(
    'adwaita-fonts: Default font'
    'adwaita-icon-theme: Default icon theme'
    'gnome-themes-extra-gtk2: Default widget theme'
    'python: gtk-builder-convert'
  )
  provides=(
    libgailutil.so
    libgdk-x11-2.0.so
    libgtk-x11-2.0.so
  )
  install=gtk2.install

  make -C "gtk-${pkgver}" DESTDIR="$pkgdir" install

  install -Dm644 /dev/stdin "$pkgdir/usr/share/gtk-2.0/gtkrc" <<END
gtk-icon-theme-name = "Adwaita"
gtk-theme-name = "Adwaita"
gtk-font-name = "Adwaita Sans 11"
END

  # Install the downloaded hook file
  install -Dm644 ../gtk-query-immodules-2.0.hook -t "$pkgdir/usr/share/libalpm/hooks"

  # Built by GTK 4, shared with GTK 2/3
  rm "$pkgdir/usr/bin/gtk-update-icon-cache"
}
