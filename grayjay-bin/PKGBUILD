# Maintainer: Nathan Chere <aur@nathanchere.com.au>
pkgname=grayjay-bin
pkgver=0
pkgrel=1
pkgdesc="Grayjay Desktop - follow creators, not platforms (privacy- and freedom-respecting client for YouTube, Rumble, Twitch, Spotify etc)"
arch=('x86_64')
url="https://grayjay.app/desktop/"
license=('Source First License 1.1')
depends=('gtk3' 'unzip' 'libnotify' 'nss' 'libxss' 'libxtst' 'xdg-utils' 'at-spi2-core' 'libsecret' 'libappindicator-gtk3')
makedepends=('curl')
provides=('grayjay')
conflicts=('grayjay-git')
options=(!strip)

# --- auto-latest logic ---
_max_probe=999   # emeld/csökkentsd, ha akarod

_latest_ver() {
  local v url
  for ((v=_max_probe; v>=1; v--)); do
    url="https://updater.grayjay.app/Apps/Grayjay.Desktop/${v}/Grayjay.Desktop-linux-x64-v${v}.zip"
    # HEAD request: ha 200/3xx, akkor létezik
    if curl -fsI --max-time 10 "$url" >/dev/null; then
      echo "$v"
      return 0
    fi
  done
  return 1
}

pkgver() {
  _latest_ver
}

_filename="Grayjay.Desktop-linux-x64-v${pkgver}"
source=("${_filename}.zip::https://updater.grayjay.app/Apps/Grayjay.Desktop/${pkgver}/${_filename}.zip")
sha256sums=('SKIP')

prepare() {
  mkdir -p "${srcdir}/grayjay"
  unzip -q "${srcdir}/${_filename}.zip" -d "${srcdir}/grayjay"
}

package() {
  cd "${srcdir}/grayjay/${_filename}"

  install -dm755 "${pkgdir}/usr/share/grayjay"
  install -dm755 "${pkgdir}/usr/bin"
  install -dm755 "${pkgdir}/usr/share/applications"
  install -dm755 "${pkgdir}/usr/share/icons/hicolor/512x512/apps"

  cat > "${pkgdir}/usr/bin/grayjay" << 'EOF'
#!/bin/sh
APP_DIR="$HOME/.local/share/grayjay"

if [ ! -d "$APP_DIR" ]; then
    echo "First run - installing Grayjay to $APP_DIR"
    mkdir -p "$APP_DIR"
    cp -r /usr/share/grayjay/* "$APP_DIR/"
    chmod u+w -R "$APP_DIR"
fi

exec sh -c "cd '$APP_DIR' && exec ./Grayjay \"\$@\"" -- "$@"
EOF
  chmod 755 "${pkgdir}/usr/bin/grayjay"

  cp -r ./* "${pkgdir}/usr/share/grayjay/"

  cat > "${pkgdir}/usr/share/applications/grayjay.desktop" << EOF
[Desktop Entry]
Name=Grayjay
Comment=Privacy-respecting client for YouTube, Rumble, Twitch, Spotify etc
Exec=/usr/bin/grayjay
Icon=grayjay
Terminal=false
Type=Application
Categories=Network;Video;AudioVideo;
EOF

  install -Dm644 "grayjay.png" \
    "${pkgdir}/usr/share/icons/hicolor/512x512/apps/grayjay.png"
}
