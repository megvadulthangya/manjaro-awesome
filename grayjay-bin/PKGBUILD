# Maintainer: Nathan Chere <aur@nathanchere.com.au>
pkgname=grayjay-bin
pkgver=16
pkgrel=1
pkgdesc="Grayjay Desktop - follow creators, not platforms (privacy- and freedom-respecting client for YouTube, Rumble, Twitch, Spotify etc)"
arch=('x86_64')
url="https://grayjay.app/desktop/"
license=('Source First License 1.1')
depends=('gtk3' 'unzip' 'libnotify' 'nss' 'libxss' 'libxtst' 'xdg-utils' 'at-spi2-core' 'libsecret' 'libappindicator-gtk3')
makedepends=('curl' 'unzip')
provides=('grayjay')
conflicts=('grayjay-git')
options=(!strip)

_probe_max=50

_url_for_ver() {
  local v="$1"
  echo "https://updater.grayjay.app/Apps/Grayjay.Desktop/${v}/Grayjay.Desktop-linux-x64-v${v}.zip"
}

_exists_ver() {
  local v="$1"
  local u="$(_url_for_ver "$v")"
  curl -fsSL \
    --retry 2 --retry-delay 1 \
    --connect-timeout 10 --max-time 20 \
    --range 0-0 \
    -o /dev/null \
    "$u" >/dev/null
}

_latest_ver_from_brew_api() {
  local api="https://formulae.brew.sh/api/cask/grayjay.json"
  local ver

  ver="$(
    curl -fsSL --retry 2 --retry-delay 1 --connect-timeout 10 --max-time 20 "$api" \
      | tr -d '\n' \
      | sed -n 's/.*"version":"\([0-9]\+\)".*/\1/p'
  )"

  [[ "$ver" =~ ^[0-9]+$ ]] && echo "$ver"
}

_latest_ver_probe_desc() {
  local v
  for ((v=_probe_max; v>=1; v--)); do
    if _exists_ver "$v"; then
      echo "$v"
      return 0
    fi
  done
  return 1
}

_resolve_pkgver() {
  local v

  if [[ "$pkgver" =~ ^[0-9]+$ ]] && (( pkgver > 0 )); then
    echo "$pkgver"
    return 0
  fi

  v="$(_latest_ver_from_brew_api)"
  if [[ -n "$v" ]]; then
    echo "$v"
    return 0
  fi

  _latest_ver_probe_desc
}

pkgver="$(_resolve_pkgver)" || {
  echo "ERROR: Could not determine latest Grayjay version." >&2
  echo "       Tried: brew API, then probe ${_probe_max}..1 on updater.grayjay.app" >&2
  exit 1
}

_filename="Grayjay.Desktop-linux-x64-v${pkgver}"
source=("${_filename}.zip::https://updater.grayjay.app/Apps/Grayjay.Desktop/${pkgver}/${_filename}.zip")
sha256sums=('SKIP')

# FONTOS: ezzel megakadályozzuk, hogy makepkg automatikusan kibontsa bsdtar-ral
# (különben a prepare() is kibontja -> duplázás).
noextract=("${_filename}.zip")

prepare() {
  rm -rf "${srcdir}/grayjay"
  mkdir -p "${srcdir}/grayjay"
  unzip -q -o "${srcdir}/${_filename}.zip" -d "${srcdir}/grayjay"
}

package() {
  cd "${srcdir}/grayjay/${_filename}"

  install -dm755 "${pkgdir}/usr/share/grayjay"
  install -dm755 "${pkgdir}/usr/bin"
  install -dm755 "${pkgdir}/usr/share/applications"
  install -dm755 "${pkgdir}/usr/share/icons/hicolor/512x512/apps"

  cat > "${pkgdir}/usr/bin/grayjay" << 'EOF'
#!/bin/sh
APP_DIR="$HOME/.local/share/grayjay"

if [ ! -d "$APP_DIR" ]; then
    echo "First run - installing Grayjay to $APP_DIR"
    mkdir -p "$APP_DIR"
    cp -r /usr/share/grayjay/* "$APP_DIR/"
    chmod u+w -R "$APP_DIR"
fi

exec sh -c "cd '$APP_DIR' && exec ./Grayjay \"\$@\"" -- "$@"
EOF
  chmod 755 "${pkgdir}/usr/bin/grayjay"

  cp -r ./* "${pkgdir}/usr/share/grayjay/"

  cat > "${pkgdir}/usr/share/applications/grayjay.desktop" << EOF
[Desktop Entry]
Name=Grayjay
Comment=Privacy-respecting client for YouTube, Rumble, Twitch, Spotify etc
Exec=/usr/bin/grayjay
Icon=grayjay
Terminal=false
Type=Application
Categories=Network;Video;AudioVideo;
EOF

  install -Dm644 "grayjay.png" \
    "${pkgdir}/usr/share/icons/hicolor/512x512/apps/grayjay.png"
}
